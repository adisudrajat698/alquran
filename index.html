<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Dompet Digital Profesional</title>
    <script src="https://unpkg.com/feather-icons"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- jsPDF library for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <style>
        /* Custom CSS untuk font dan warna */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8; /* Latar belakang lebih terang dan bersih */
            color: #333;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        /* Sidebar: Warna biru tua solid, modern */
        .sidebar {
            background-color: #1a365d; /* Biru tua yang lebih dalam */
            color: #e2e8f0; /* Teks abu-abu kebiruan terang */
            width: 280px;
            transform: translateX(-100%);
            transition: transform 0.3s ease-in-out, background-color 0.3s ease, color 0.3s ease;
            z-index: 50;
            box-shadow: 2px 0 10px rgba(0,0,0,0.3); /* Bayangan lebih kuat */
        }
        .sidebar.open {
            transform: translateX(0);
        }
        .sidebar-item {
            display: flex;
            align-items: center;
            padding: 1rem 1.5rem; /* Padding lebih besar */
            border-radius: 0.75rem; /* rounded-lg */
            font-size: 1rem; /* text-base */
            font-weight: 500;
            transition: background-color 0.2s, color 0.2s, transform 0.1s ease;
        }
        .sidebar-item i {
            margin-right: 1rem; /* Spasi lebih besar */
            color: #90cdf4; /* Warna ikon yang kontras */
        }
        .sidebar-item:hover {
            background-color: #2a4365; /* Warna hover sedikit lebih terang */
            color: #ffffff;
            transform: translateX(5px); /* Efek geser kecil */
        }
        .sidebar-item.active {
            background-color: #3182ce; /* Biru cerah untuk aktif */
            color: white;
            font-weight: 600;
            box-shadow: 0 4px 8px rgba(49, 130, 206, 0.4); /* Bayangan untuk item aktif */
            transform: translateX(0); /* Pastikan tidak bergeser jika aktif */
        }
        .header {
            background-color: #ffffff;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            z-index: 40;
            transition: background-color 0.3s ease, box-shadow 0.3s ease;
        }
        .main-content {
            background-color: #f0f4f8; /* Sesuai dengan body */
            transition: background-color 0.3s ease;
        }
        .card {
            background-color: #ffffff;
            border-radius: 1.25rem; /* rounded-2xl untuk kesan lebih lembut */
            box-shadow: 0 8px 16px rgba(0,0,0,0.08); /* Bayangan yang lebih menonjol */
            transition: background-color 0.3s ease, box-shadow 0.3s ease;
        }
        input[type="text"],
        input[type="password"],
        input[type="number"],
        input[type="date"],
        select {
            border-color: #cbd5e0; /* gray-300 */
            border-width: 1px;
            border-radius: 0.75rem; /* rounded-lg */
            padding: 0.875rem 1.25rem; /* Padding lebih besar */
            width: 100%;
            outline: none;
            background-color: #ffffff;
            color: #4a5568; /* Teks abu-abu gelap */
            transition: border-color 0.2s, background-color 0.3s ease, color 0.3s ease, box-shadow 0.2s;
        }
        input[type="text"]:focus,
        input[type="password"]:focus,
        input[type="number"]:focus,
        input[type="date"]:focus,
        select:focus {
            border-color: #3182ce; /* blue-600 */
            box-shadow: 0 0 0 5px rgba(49, 130, 206, 0.25); /* Efek fokus yang lebih menonjol */
            background-color: #ffffff;
        }
        .btn-primary {
            background-image: linear-gradient(to right, #3182ce, #4299e1); /* Gradient biru */
            color: white;
            padding: 1rem 2rem; /* Padding lebih besar untuk tombol utama */
            border-radius: 0.75rem; /* rounded-xl */
            font-weight: 700; /* font-bold */
            transition: all 0.2s ease-in-out;
            box-shadow: 0 4px 10px rgba(49, 130, 206, 0.4);
            border: none;
        }
        .btn-primary:hover {
            background-image: linear-gradient(to right, #4299e1, #63b3ed); /* Gradient hover yang lebih cerah */
            transform: translateY(-2px); /* Efek angkat lebih jelas */
            box-shadow: 0 6px 15px rgba(49, 130, 206, 0.5);
        }
        .btn-primary:active {
            transform: translateY(0);
            box-shadow: 0 2px 5px rgba(49, 130, 206, 0.2);
        }
        .btn-danger {
            background-color: #e53e3e; /* red-600 */
            color: white;
            padding: 0.75rem 1.5rem; /* Padding konsisten */
            border-radius: 0.625rem; /* rounded-lg */
            font-weight: 600;
            transition: background-color 0.2s, transform 0.1s ease;
            box-shadow: 0 2px 6px rgba(229, 62, 62, 0.3);
            border: none;
        }
        .btn-danger:hover {
            background-color: #c53030; /* red-700 */
            transform: translateY(-1px);
            box-shadow: 0 4px 10px rgba(229, 62, 62, 0.4);
        }
        .btn-danger:active {
            transform: translateY(0);
            box-shadow: 0 1px 3px rgba(229, 62, 62, 0.1);
        }
        .btn-secondary {
            background-color: #718096; /* gray-600 */
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.625rem;
            font-weight: 600;
            transition: background-color 0.2s, transform 0.1s ease;
            box-shadow: 0 2px 6px rgba(113, 128, 150, 0.3);
            border: none;
        }
        .btn-secondary:hover {
            background-color: #5d687b; /* gray-700 */
            transform: translateY(-1px);
            box-shadow: 0 4px 10px rgba(113, 128, 150, 0.4);
        }
        .btn-secondary:active {
            transform: translateY(0);
            box-shadow: 0 1px 3px rgba(113, 128, 150, 0.1);
        }
        .text-income {
            color: #38a169; /* green-600 */
        }
        .text-expense {
            color: #e53e3e; /* red-600 */
        }

        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7); /* Lebih gelap */
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
        }
        .modal-content {
            background-color: white;
            padding: 3rem; /* Padding lebih besar */
            border-radius: 1.5rem; /* rounded-3xl */
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.25); /* Bayangan lebih dalam */
            max-width: 90%;
            width: 600px; /* Lebar modal lebih lebar */
            position: relative;
            transition: background-color 0.3s ease, box-shadow 0.3s ease;
            animation: modalFadeIn 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
        }
        @keyframes modalFadeIn {
            from { opacity: 0; transform: translateY(-30px) scale(0.95); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }
        .modal-close-btn {
            position: absolute;
            top: 1.25rem;
            right: 1.25rem;
            background: none;
            border: none;
            font-size: 2rem; /* Ukuran ikon lebih besar */
            cursor: pointer;
            color: #a0aec0; /* gray-400 */
            transition: color 0.2s;
        }
        .modal-close-btn:hover {
            color: #718096; /* gray-600 */
        }

        /* Chart Styles */
        .chart-bar-container {
            display: flex;
            align-items: flex-end;
            height: 200px; /* Tinggi lebih besar */
            background-color: #edf2f7; /* gray-100 */
            border-radius: 1rem; /* rounded-xl */
            overflow: hidden;
            position: relative;
            transition: background-color 0.3s ease;
            padding: 1rem; /* Padding di dalam container chart */
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.05); /* Inset shadow */
        }
        .chart-bar {
            width: 50%;
            height: 0; /* Initial height */
            transition: height 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94); /* Smooth ease-out */
            display: flex;
            flex-direction: column; /* Untuk menempatkan label di atas */
            align-items: center;
            justify-content: flex-end;
            color: white;
            font-weight: bold;
            font-size: 1rem; /* text-base */
            position: relative;
            border-radius: 0.5rem 0.5rem 0 0; /* Sudut atas membulat */
            margin: 0 0.5rem; /* Jarak antar bar */
        }
        .chart-bar span {
            position: absolute;
            top: 0.5rem; /* Label di atas bar */
            color: #ffffff; /* Teks putih di dalam bar */
            font-weight: bold;
            font-size: 0.875rem; /* text-sm */
            text-shadow: 1px 1px 2px rgba(0,0,0,0.4);
            transform: translateY(-100%); /* Geser ke atas dari bar */
            white-space: nowrap; /* Jangan putus baris */
        }
        .chart-bar-income {
            background-color: #38a169; /* green-600 */
        }
        .chart-bar-expense {
            background-color: #e53e3e; /* red-600 */
        }

        /* Responsive table for reports */
        .responsive-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
        }
        .responsive-table th, .responsive-table td {
            padding: 1rem 1.25rem; /* Padding lebih nyaman */
            text-align: left;
            border-bottom: 1px solid #e2e8f0; /* gray-200 */
            transition: border-color 0.3s ease;
        }
        .responsive-table th {
            background-color: #f7fafc; /* gray-100 */
            font-weight: 600;
            color: #4a5568; /* Teks abu-abu gelap */
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        .responsive-table tbody tr:last-child td {
            border-bottom: none;
        }
        .responsive-table tbody tr:hover {
            background-color: #edf2f7; /* gray-100 saat hover */
        }
        @media (max-width: 767px) {
            .responsive-table, .responsive-table thead, .responsive-table tbody, .responsive-table th, .responsive-table td, .responsive-table tr {
                display: block;
            }
            .responsive-table thead tr {
                position: absolute;
                top: -9999px;
                left: -9999px;
            }
            .responsive-table tr {
                margin-bottom: 1.5rem;
                border: 1px solid #e2e8f0;
                border-radius: 1rem; /* rounded-xl */
                overflow: hidden;
                box-shadow: 0 4px 8px rgba(0,0,0,0.05);
            }
            .responsive-table td {
                border: none;
                border-bottom: 1px solid #f0f4f8; /* Lebih lembut */
                position: relative;
                padding-left: 55%; /* Ruang lebih untuk label */
                text-align: right;
            }
            .responsive-table td:last-child {
                border-bottom: none;
            }
            .responsive-table td:before {
                position: absolute;
                top: 0;
                left: 1.25rem; /* Padding label dari kiri */
                width: 45%;
                padding-right: 10px;
                white-space: nowrap;
                text-align: left;
                font-weight: 600;
                color: #4a5568;
            }
            /* Label the data */
            .responsive-table td:nth-of-type(1):before { content: "Deskripsi"; }
            .responsive-table td:nth-of-type(2):before { content: "Tanggal"; }
            .responsive-table td:nth-of-type(3):before { content: "Jumlah"; }
            .responsive-table td:nth-of-type(4):before { content: "Tipe"; }
            .responsive-table td:nth-of-type(5):before { content: "Kategori"; }
        }

        /* Responsiveness */
        @media (min-width: 768px) {
            .sidebar {
                transform: translateX(0);
            }
            .content-wrapper {
                margin-left: 280px;
            }
            .menu-button {
                display: none;
            }
        }

        /* Notification Styles */
        #notificationContainer {
            position: fixed;
            top: 2rem;
            right: 2rem;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 1rem; /* Jarak antar notifikasi lebih besar */
            pointer-events: none;
        }
        .notification {
            background-color: #333;
            color: white;
            padding: 1.25rem 1.75rem; /* Padding lebih besar */
            border-radius: 1rem; /* rounded-xl */
            box-shadow: 0 8px 18px rgba(0, 0, 0, 0.2); /* Bayangan lebih jelas */
            opacity: 0;
            transform: translateY(-30px);
            animation: fadeInOut 4s forwards; /* Durasi lebih lama */
            min-width: 280px;
            max-width: 400px;
            text-align: center;
            pointer-events: all;
            font-size: 1rem;
        }
        .notification.success {
            background-color: #38a169; /* green-600 */
        }
        .notification.error {
            background-color: #e53e3e; /* red-600 */
        }
        .notification.info {
            background-color: #3182ce; /* blue-600 */
        }
        @keyframes fadeInOut {
            0% { opacity: 0; transform: translateY(-30px); }
            10% { opacity: 1; transform: translateY(0); }
            90% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(-30px); }
        }

        /* JSON Display Modal */
        #jsonDisplayModal .modal-content {
            width: 90%;
            max-width: 750px;
        }
        #jsonOutput {
            width: 100%;
            height: 350px; /* Tinggi lebih besar */
            background-color: #f8f8f8;
            border: 1px solid #e2e8f0;
            padding: 1.25rem;
            font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, Courier, monospace; /* Font monospace yang umum */
            white-space: pre-wrap;
            word-wrap: break-word;
            overflow-y: scroll;
            resize: vertical;
            border-radius: 0.75rem;
            transition: background-color 0.3s ease, border-color 0.3s ease, color 0.3s ease;
            font-size: 0.9rem;
            color: #4a5568;
        }
        #copyJsonBtn {
            margin-top: 1.5rem; /* Jarak lebih besar */
            width: 100%;
        }

        /* Chatbot styles */
        #chatbotModal .modal-content {
            width: 90%;
            max-width: 650px;
            height: 85vh; /* Tinggi lebih besar */
            display: flex;
            flex-direction: column;
        }
        #chatDisplay {
            flex-grow: 1;
            border: 1px solid #e2e8f0;
            border-radius: 1rem; /* Rounded corners */
            padding: 1.5rem; /* Lebih banyak padding */
            overflow-y: auto;
            margin-bottom: 1.5rem;
            background-color: #f7fafc; /* Lebih terang */
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }
        .chat-message {
            margin-bottom: 1rem; /* Jarak antar pesan */
            padding: 0.875rem 1.25rem; /* Padding pesan lebih besar */
            border-radius: 1rem; /* Rounded corners */
            max-width: 90%; /* Lebih lebar */
            line-height: 1.6;
            font-size: 0.95rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05); /* Bayangan kecil */
        }
        .chat-message.user {
            background-color: #e0f2fe; /* blue-100 */
            align-self: flex-end;
            margin-left: auto;
            text-align: right;
            color: #2a699c; /* dark blue text */
        }
        .chat-message.bot {
            background-color: #e6fffa; /* teal-50 */
            align-self: flex-start;
            margin-right: auto;
            text-align: left;
            color: #2c5282; /* dark blue-gray text */
        }
        .chat-options {
            display: flex;
            flex-wrap: wrap;
            justify-content: center; /* Opsi di tengah */
            gap: 0.75rem; /* Jarak antar tombol opsi */
        }
        .chat-options button {
            background-color: #4fd1c5; /* Teal cerah */
            color: white;
            padding: 0.75rem 1.5rem; /* Padding tombol lebih besar */
            border-radius: 0.75rem; /* rounded-lg */
            margin: 0;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.1s ease, box-shadow 0.2s;
            font-size: 0.9rem;
            font-weight: 500;
            box-shadow: 0 2px 5px rgba(79, 209, 197, 0.3);
        }
        .chat-options button:hover {
            background-color: #38b2ac; /* Teal lebih gelap */
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(79, 209, 197, 0.4);
        }
        .chat-options button:active {
            transform: translateY(0);
            box-shadow: 0 1px 3px rgba(79, 209, 197, 0.2);
        }

        /* Dark Mode Styles */
        body.dark-mode {
            background-color: #2d3748; /* dark gray */
            color: #e2e8f0; /* light gray */
        }
        body.dark-mode .sidebar {
            background-color: #1a202c; /* darker sidebar */
            color: #edf2f7;
            box-shadow: 2px 0 10px rgba(0,0,0,0.6);
        }
        body.dark-mode .sidebar-item:hover {
            background-color: #2d3748;
            color: #e2e8f0;
        }
        body.dark-mode .sidebar-item i {
            color: #a0aec0; /* Lighter icon color in dark mode */
        }
        body.dark-mode .sidebar-item.active {
            background-color: #4299e1; /* lighter blue for active */
            color: white;
            box-shadow: 0 4px 8px rgba(66, 153, 225, 0.4);
        }
        body.dark-mode .header {
            background-color: #2d3748;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }
        body.dark-mode .main-content {
            background-color: #1a202c;
        }
        body.dark-mode .card {
            background-color: #2d3748;
            box-shadow: 0 8px 16px rgba(0,0,0,0.4);
        }
        body.dark-mode input[type="text"],
        body.dark-mode input[type="password"],
        body.dark-mode input[type="number"],
        body.dark-mode input[type="date"],
        body.dark-mode select {
            background-color: #4a5568;
            border-color: #4a5568;
            color: #e2e8f0;
        }
        body.dark-mode input::placeholder {
            color: #cbd5e0;
        }
        body.dark-mode .btn-primary {
            background-image: linear-gradient(to right, #4299e1, #63b3ed);
            box-shadow: 0 4px 10px rgba(66, 153, 225, 0.4);
        }
        body.dark-mode .btn-primary:hover {
            background-image: linear-gradient(to right, #63b3ed, #90cdf4);
            box-shadow: 0 6px 15px rgba(66, 153, 225, 0.5);
        }
        body.dark-mode .btn-danger {
            background-color: #fc8181; /* lighter red */
            color: #2d3748;
            box-shadow: 0 2px 6px rgba(252, 129, 129, 0.3);
        }
        body.dark-mode .btn-danger:hover {
            background-color: #e53e3e; /* original red */
            box-shadow: 0 4px 10px rgba(252, 129, 129, 0.4);
        }
        body.dark-mode .btn-secondary {
            background-color: #a0aec0; /* lighter gray */
            color: #2d3748;
            box-shadow: 0 2px 6px rgba(160, 174, 192, 0.3);
        }
        body.dark-mode .btn-secondary:hover {
            background-color: #cbd5e0;
            box-shadow: 0 4px 10px rgba(160, 174, 192, 0.4);
        }
        body.dark-mode .text-gray-700 {
            color: #cbd5e0;
        }
        body.dark-mode .text-gray-600 {
            color: #a0aec0;
        }
        body.dark-mode .text-gray-500 {
            color: #718096;
        }
        body.dark-mode .text-blue-500 {
            color: #63b3ed;
        }
        body.dark-mode .text-blue-600 {
            color: #4299e1;
        }
        body.dark-mode .text-red-600 {
            color: #fc8181;
        }
        body.dark-mode .modal-content {
            background-color: #2d3748;
            color: #e2e8f0;
            box-shadow: 0 20px 40px rgba(0,0,0,0.45);
        }
        body.dark-mode .modal-close-btn {
            color: #a0aec0;
        }
        body.dark-mode .chart-bar-container {
            background-color: #4a5568;
        }
        body.dark-mode .chart-bar span {
            color: #e2e8f0;
        }
        body.dark-mode .responsive-table th {
            background-color: #4a5568;
            color: #e2e8f0;
            border-bottom-color: #2d3748;
        }
        body.dark-mode .responsive-table td {
            border-bottom-color: #2d3748;
        }
        body.dark-mode .responsive-table tr {
            border-color: #2d3748;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        body.dark-mode .responsive-table td:before {
            color: #a0aec0;
        }
        body.dark-mode #jsonOutput {
            background-color: #4a5568;
            border-color: #4a5568;
            color: #e2e8f0;
        }
        body.dark-mode #chatDisplay {
            background-color: #4a5568;
            border-color: #63b3ed;
            color: #e2e8f0;
        }
        body.dark-mode .chat-message.user {
            background-color: #4299e1;
            color: white;
        }
        body.dark-mode .chat-message.bot {
            background-color: #a0aec0;
            color: #2d3748;
        }
        body.dark-mode .chat-options button {
            background-color: #4fd1c5;
            color: white;
            box-shadow: 0 2px 5px rgba(79, 209, 197, 0.3);
        }
        body.dark-mode .chat-options button:hover {
            background-color: #38b2ac;
            box-shadow: 0 4px 8px rgba(79, 209, 197, 0.4);
        }
        body.dark-mode .text-income {
            color: #68d391; /* lighter green for dark mode */
        }
        body.dark-mode .text-expense {
            color: #fc8181; /* lighter red for dark mode */
        }
        body.dark-mode .bg-green-50 {
            background-color: #2d3748; /* Darker background for light elements */
            border-color: #4a5568;
        }
        body.dark-mode .bg-red-50 {
            background-color: #2d3748; /* Darker background for light elements */
            border-color: #4a5568;
        }
        body.dark-mode .bg-blue-50 {
            background-color: #2d3748; /* Darker background for light elements */
            border-color: #4a5568;
        }
        body.dark-mode .border-gray-200 {
            border-color: #4a5568;
        }
        body.dark-mode .bg-white {
            background-color: #2d3748;
        }
    </style>
</head>
<body class="flex flex-col min-h-screen md:flex-row">
    <!-- Sidebar -->
    <aside id="sidebar" class="sidebar fixed top-0 left-0 h-full p-6 flex flex-col md:relative md:flex-shrink-0">
        <div class="mb-8 text-center pt-2 pb-4 border-b border-gray-700/50">
            <img src="https://placehold.co/120x120/3182CE/FFFFFF?text=AD" alt="Logo Aplikasi" class="mx-auto w-24 h-24 mb-3 rounded-full shadow-lg">
            <div class="text-3xl font-bold text-white tracking-wide">AdiWallet</div>
        </div>

        <div class="flex flex-col items-center mb-8">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-12 h-12 text-blue-300 mb-2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M17.982 18.725A7.488 7.488 0 0 0 12 15.75a7.488 7.488 0 0 0-5.982 2.975m11.963 0A8.966 8.966 0 0 1 12 21a8.966 8.966 0 0 1-5.982-2.275M15 9.75a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" />
            </svg>
            <p id="sidebarUsername" class="text-lg font-semibold text-white mt-2"></p>
        </div>
        <nav class="flex-grow">
            <ul class="space-y-3">
              <li id="dashboardSidebarItem"><a href="#" class="sidebar-item" data-section="dashboard"><i data-feather="home" class="w-5 h-5"></i> Dashboard </a></li>
              <li id="transactionsSidebarItem"><a href="#" class="sidebar-item" data-section="transactions"><i data-feather="repeat" class="w-5 h-5"></i> Transaksi </a></li>
              <li id="budgetingSidebarItem"><a href="#" class="sidebar-item" data-section="budgeting"><i data-feather="target" class="w-5 h-5"></i> Rencana Anggaran </a></li>
              <li id="reportsSidebarItem"><a href="#" class="sidebar-item" data-section="reports"><i data-feather="bar-chart-2" class="w-5 h-5"></i> Laporan </a></li>
              <li id="analysisSidebarItem"><a href="#" class="sidebar-item" data-section="analysis"><i data-feather="pie-chart" class="w-5 h-5"></i> Analisis Keuangan </a></li>
              <li id="settingsSidebarItem"><a href="#" class="sidebar-item" data-section="settings"><i data-feather="settings" class="w-5 h-5"></i> Pengaturan </a></li>
              <li id="helpSidebarItem"><a href="#" class="sidebar-item" data-section="help"><i data-feather="help-circle" class="w-5 h-5"></i> Bantuan </a></li>
            </ul>
        </nav>
        <div class="mt-auto pt-4 border-t border-gray-700/50">
            <button id="logoutBtn" class="w-full btn-primary">Logout</button>
        </div>
    </aside>

    <div class="flex-grow flex flex-col content-wrapper md:ml-0">
        <!-- Header untuk Mobile -->
        <header class="header p-4 flex items-center justify-between sticky top-0 md:hidden">
            <button id="menuBtn" class="menu-button text-gray-600 focus:outline-none p-2 rounded-md hover:bg-gray-100 transition-colors">
                <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
            </button>
            <h1 class="text-xl font-semibold text-gray-800">AdiWallet</h1>
            <div class="w-7 h-7"></div> <!-- Placeholder untuk menjaga keseimbangan -->
        </header>

        <main class="flex-grow p-4 md:p-8 overflow-y-auto">
            <!-- Auth Section -->
            <section id="authSection" class="flex items-center justify-center min-h-screen-minus-header">
                <div class="card p-8 w-full max-w-md">
                   <div class="flex flex-col items-center mb-6">
                        <img src="https://placehold.co/150x150/3182CE/FFFFFF?text=AD" alt="Logo Aplikasi" class="w-32 h-32 mb-4 rounded-full shadow-lg">
                        <h2 class="text-4xl font-extrabold text-center text-gray-800" id="authTitle">Login</h2>
                    </div>
                    <form id="authForm" class="space-y-6">
                        <div>
                            <label for="username" class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                            <input type="email" id="username" name="username" required class="block w-full">
                        </div>
                        <div>
                            <label for="password" class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                            <input type="password" id="password" name="password" required class="block w-full">
                        </div>
                        <p id="authMessage" class="text-red-500 text-sm hidden text-center"></p>
                        <button type="submit" id="authSubmitBtn" class="w-full btn-primary">Login</button>
                    </form>
                    <p class="text-center text-base mt-6 text-gray-600">
                        <a href="#" id="forgotPasswordLink" class="text-blue-600 hover:underline">Lupa Kata Sandi?</a>
                        <span class="mx-2">|</span>
                        Belum punya akun? <a href="#" id="toggleAuthMode" class="text-blue-600 hover:underline">Daftar di sini</a>
                    </p>
                </div>
            </section>

            <!-- Dashboard Section -->
            <section id="dashboardSection" class="hidden">
                <h2 class="text-3xl font-bold text-gray-800 mb-6">Dashboard</h2>
                <div class="flex items-center gap-4 mb-8 p-4 bg-blue-50 rounded-xl shadow-sm">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-9 h-9 text-blue-600">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M17.982 18.725A7.488 7.488 0 0 0 12 15.75a7.488 7.488 0 0 0-5.982 2.975m11.963 0A8.966 8.966 0 0 1 12 21a8.966 8.966 0 0 1-5.982-2.275M15 9.75a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" />
                    </svg>
                    <p class="text-xl text-gray-700">Selamat datang, <span id="dashboardUsername" class="font-semibold text-blue-700"></span>!</p>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <div class="card p-6 text-center flex flex-col items-center">
                        <i data-feather="credit-card" class="w-14 h-14 text-blue-500 mb-4"></i>
                        <h3 class="text-lg font-medium text-gray-600">Saldo Saat Ini</h3>
                        <p id="currentBalance" class="text-5xl font-extrabold mt-2 text-gray-800">Rp 0</p>
                    </div>
                    <div class="card p-6 text-center flex flex-col items-center">
                        <i data-feather="arrow-down-left" class="w-14 h-14 text-green-600 mb-4"></i>
                        <h3 class="text-lg font-medium text-gray-600">Total Pemasukan</h3>
                        <p id="totalIncome" class="text-3xl font-bold text-income mt-2">Rp 0</p>
                    </div>
                    <div class="card p-6 text-center flex flex-col items-center">
                        <i data-feather="arrow-up-right" class="w-14 h-14 text-red-600 mb-4"></i>
                        <h3 class="text-lg font-medium text-gray-600">Total Pengeluaran</h3>
                        <p id="totalExpense" class="text-3xl font-bold text-expense mt-2">Rp 0</p>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                    <div class="card p-6">
                        <h3 class="text-2xl font-bold text-gray-800 mb-4">Ringkasan Pemasukan & Pengeluaran</h3>
                        <div id="incomeExpenseChart" class="chart-bar-container">
                            </div>
                    </div>
                    <div class="card p-6">
                        <h3 class="text-2xl font-bold text-gray-800 mb-4">Pengeluaran Berdasarkan Kategori</h3>
                        <div id="expenseByCategorySummary" class="space-y-3">
                            <p class="text-gray-500 text-center">Belum ada pengeluaran berdasarkan kategori.</p>
                        </div>
                    </div>
                </div>

                <div class="card p-6">
                    <h3 class="text-2xl font-bold text-gray-800 mb-4">Transaksi Terbaru</h3>
                    <div id="latestTransactions" class="space-y-4">
                        <p class="text-gray-500 text-center">Belum ada transaksi.</p>
                    </div>
                </div>
            </section>

            <!-- Transactions Section -->
            <section id="transactionsSection" class="hidden">
                <h2 class="text-3xl font-bold text-gray-800 mb-6">Transaksi</h2>
                <div class="card p-6 mb-8">
                    <h3 class="text-2xl font-bold text-gray-800 mb-4">Tambah Transaksi Baru</h3>
                    <form id="transactionForm" class="space-y-5">
                        <div>
                            <label for="transactionDate" class="block text-sm font-medium text-gray-700 mb-1">Tanggal</label>
                            <input type="date" id="transactionDate" required class="block">
                        </div>
                        <div>
                            <label for="transactionDescription" class="block text-sm font-medium text-gray-700 mb-1">Deskripsi</label>
                            <input type="text" id="transactionDescription" placeholder="Contoh: Beli Kopi" required class="block">
                        </div>
                        <div>
                            <label for="transactionAmount" class="block text-sm font-medium text-gray-700 mb-1">Jumlah (Rp)</label>
                            <input type="number" id="transactionAmount" placeholder="Contoh: 25000" required min="1" class="block">
                        </div>
                        <div>
                            <label for="transactionType" class="block text-sm font-medium text-gray-700 mb-1">Tipe</label>
                            <select id="transactionType" required class="block">
                                <option value="income">Pemasukan</option>
                                <option value="expense">Pengeluaran</option>
                            </select>
                        </div>
                        <div>
                            <label for="transactionCategory" class="block text-sm font-medium text-gray-700 mb-1">Kategori</label>
                            <select id="transactionCategory" required class="block">
                                </select>
                        </div>
                        <button type="submit" class="w-full btn-primary">Tambah Transaksi</button>
                    </form>
                </div>

                <div class="card p-6">
                    <h3 class="text-2xl font-bold text-gray-800 mb-4">Daftar Semua Transaksi</h3>
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-5">
                        <div class="col-span-full lg:col-span-1">
                            <label for="transactionSearchInput" class="block text-sm font-medium text-gray-700 mb-1">Cari Deskripsi</label>
                            <input type="text" id="transactionSearchInput" placeholder="Cari transaksi..." class="block">
                        </div>
                        <div>
                            <label for="filterType" class="block text-sm font-medium text-gray-700 mb-1">Filter Tipe</label>
                            <select id="filterType" class="block">
                                <option value="all">Semua</option>
                                <option value="income">Pemasukan</option>
                                <option value="expense">Pengeluaran</option>
                            </select>
                        </div>
                        <div>
                            <label for="filterStartDate" class="block text-sm font-medium text-gray-700 mb-1">Tanggal Mulai</label>
                            <input type="date" id="filterStartDate" class="block">
                        </div>
                        <div>
                            <label for="filterEndDate" class="block text-sm font-medium text-gray-700 mb-1">Tanggal Akhir</label>
                            <input type="date" id="filterEndDate" class="block">
                        </div>
                        <div class="col-span-full sm:col-span-2 lg:col-span-1">
                            <label for="sortBy" class="block text-sm font-medium text-gray-700 mb-1">Urutkan Berdasarkan</label>
                            <select id="sortBy" class="block">
                                <option value="dateDesc">Tanggal (Terbaru)</option>
                                <option value="dateAsc">Tanggal (Terlama)</option>
                                <option value="amountDesc">Jumlah (Terbesar)</option>
                                <option value="amountAsc">Jumlah (Terkecil)</option>
                            </select>
                        </div>
                    </div>
                    <div id="allTransactionsList" class="space-y-4">
                        <p class="text-gray-500 text-center">Belum ada transaksi.</p>
                    </div>
                    <div id="paginationControls" class="flex justify-center items-center gap-4 mt-6">
                        <button id="prevPageBtn" class="btn-secondary px-5 py-2 rounded-lg" disabled>Sebelumnya</button>
                        <span id="pageInfo" class="text-gray-700 text-base font-medium">Halaman 1 dari 1</span>
                        <button id="nextPageBtn" class="btn-secondary px-5 py-2 rounded-lg" disabled>Berikutnya</button>
                    </div>
                </div>
            </section>

            <!-- New Budgeting Section -->
            <section id="budgetingSection" class="hidden">
                <h2 class="text-3xl font-bold text-gray-800 mb-6">Rencana Anggaran</h2>
                <div class="card p-6 mb-8">
                    <h3 class="text-2xl font-bold text-gray-800 mb-4">Tetapkan Anggaran Baru</h3>
                    <form id="budgetForm" class="space-y-5">
                        <div>
                            <label for="budgetItemCategory" class="block text-sm font-medium text-gray-700 mb-1">Kategori</label>
                            <select id="budgetItemCategory" required class="block">
                                <!-- Categories will be loaded here -->
                            </select>
                        </div>
                        <div>
                            <label for="budgetAmount" class="block text-sm font-medium text-gray-700 mb-1">Jumlah Anggaran (Rp)</label>
                            <input type="number" id="budgetAmount" placeholder="Contoh: 500000" required min="1" class="block">
                        </div>
                        <div>
                            <label for="budgetStartDate" class="block text-sm font-medium text-gray-700 mb-1">Tanggal Mulai</label>
                            <input type="date" id="budgetStartDate" required class="block">
                        </div>
                        <div>
                            <label for="budgetEndDate" class="block text-sm font-medium text-gray-700 mb-1">Tanggal Akhir</label>
                            <input type="date" id="budgetEndDate" required class="block">
                        </div>
                        <button type="submit" class="w-full btn-primary">Simpan Anggaran</button>
                    </form>
                    <p id="budgetMessage" class="text-red-500 text-sm hidden mt-4 text-center"></p>
                </div>

                <div class="card p-6">
                    <h3 class="text-2xl font-bold text-gray-800 mb-4">Daftar Anggaran Anda</h3>
                    <div id="budgetList" class="space-y-4">
                        <p class="text-gray-500 text-center">Belum ada anggaran yang ditetapkan.</p>
                    </div>
                </div>
            </section>

            <!-- Reports Section -->
            <section id="reportsSection" class="hidden">
                <h2 class="text-3xl font-bold text-gray-800 mb-6">Laporan Keuangan</h2>
                <div class="card p-6 mb-8">
                    <h3 class="text-2xl font-bold text-gray-800 mb-4">Ringkasan Laporan</h3>
                    <div class="flex flex-col sm:flex-row gap-4 mb-5">
                        <div class="flex-1">
                            <label for="reportMonthSelect" class="block text-sm font-medium text-gray-700 mb-1">Bulan</label>
                            <select id="reportMonthSelect" class="block">
                                <option value="all">Semua Bulan</option>
                                <option value="01">Januari</option>
                                <option value="02">Februari</option>
                                <option value="03">Maret</option>
                                <option value="04">April</option>
                                <option value="05">Mei</option>
                                <option value="06">Juni</option>
                                <option value="07">Juli</option>
                                <option value="08">Agustus</option>
                                <option value="09">September</option>
                                <option value="10">Oktober</option>
                                <option value="11">November</option>
                                <option value="12">Desember</option>
                            </select>
                        </div>
                        <div class="flex-1">
                            <label for="reportYearSelect" class="block text-sm font-medium text-gray-700 mb-1">Tahun</label>
                            <select id="reportYearSelect" class="block">
                                </select>
                        </div>
                    </div>
                    <div class="space-y-4 text-gray-800">
                        <p class="text-lg">Total Pemasukan: <span id="reportTotalIncome" class="font-semibold text-income">Rp 0</span></p>
                        <p class="text-lg">Total Pengeluaran: <span id="reportTotalExpense" class="font-semibold text-expense">Rp 0</span></p>
                        <p class="text-lg">Saldo Bersih: <span id="reportNetBalance" class="font-semibold">Rp 0</span></p>
                    </div>

                    <h4 class="text-xl font-bold text-gray-800 mt-8 mb-4">Grafik Pemasukan dan Pengeluaran Bulanan</h4>
                    <div class="relative h-72 w-full">
                        <canvas id="monthlySummaryChart"></canvas>
                    </div>

                    <h4 class="text-xl font-bold text-gray-800 mt-8 mb-4">Pengeluaran per Kategori (Grafik Lingkaran)</h4>
                    <div class="relative h-72 w-full">
                        <canvas id="expenseByCategoryChart"></canvas>
                    </div>

                    <h4 class="text-xl font-bold text-gray-800 mt-8 mb-4">Pemasukan per Kategori (Grafik Lingkaran)</h4>
                    <div class="relative h-72 w-full">
                        <canvas id="incomeByCategoryChart"></canvas>
                    </div>

                    <h4 class="text-xl font-bold text-gray-800 mt-8 mb-4">Pengeluaran per Kategori</h4>
                    <div id="reportExpenseByCategory" class="space-y-3">
                        <p class="text-gray-500 text-center">Belum ada data pengeluaran per kategori.</p>
                    </div>
                    <h4 class="text-xl font-bold text-gray-800 mt-8 mb-4">Pemasukan per Kategori</h4>
                    <div id="reportIncomeByCategory" class="space-y-3">
                        <p class="text-gray-500 text-center">Belum ada data pemasukan per kategori.</p>
                    </div>
                    <h4 class="text-xl font-bold text-gray-800 mt-8 mb-4">Detail Transaksi</h4>
                    <div id="reportTransactionsList" class="overflow-x-auto">
                        <p class="text-gray-500 text-center">Belum ada transaksi untuk laporan.</p>
                    </div>
                    <button id="generatePdfReportBtn" class="w-full btn-primary mt-6">Generate Laporan PDF</button>
                </div>
            </section>

            <!-- Analysis Section -->
            <section id="analysisSection" class="hidden">
                <h2 class="text-3xl font-bold text-gray-800 mb-6">Analisis Keuangan</h2>
                <div class="card p-6 mb-8">
                    <h3 class="text-2xl font-bold text-gray-800 mb-4">Tren Keuangan Bulanan</h3>
                    <p class="text-gray-700 mb-4">Lihat bagaimana pemasukan, pengeluaran, dan saldo Anda berkembang dari waktu ke waktu.</p>
                    <div class="relative h-80 w-full">
                        <canvas id="financialTrendsChart"></canvas>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                    <div class="card p-6">
                        <h3 class="text-2xl font-bold text-gray-800 mb-4">5 Kategori Pengeluaran Teratas</h3>
                        <div class="relative h-72 w-full">
                            <canvas id="topExpenseCategoriesChart"></canvas>
                        </div>
                        <div id="topExpenseCategoriesSummary" class="space-y-2 mt-4">
                            <p class="text-gray-500 text-center">Belum ada data pengeluaran.</p>
                        </div>
                    </div>
                    <div class="card p-6">
                        <h3 class="text-2xl font-bold text-gray-800 mb-4">5 Kategori Pemasukan Teratas</h3>
                        <div class="relative h-72 w-full">
                            <canvas id="topIncomeCategoriesChart"></canvas>
                        </div>
                        <div id="topIncomeCategoriesSummary" class="space-y-2 mt-4">
                            <p class="text-gray-500 text-center">Belum ada data pemasukan.</p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Settings Section -->
            <section id="settingsSection" class="hidden">
                <h2 class="text-3xl font-bold text-gray-800 mb-6">Pengaturan</h2>

                <div class="card p-6 mb-8">
                    <h3 class="text-2xl font-bold text-gray-800 mb-4">Mode Tampilan</h3>
                    <div class="flex items-center space-x-3">
                        <label for="darkModeToggle" class="block text-lg font-medium text-gray-700 cursor-pointer">Mode Gelap</label>
                        <!-- Basic toggle switch HTML (Tailwind friendly) -->
                        <div class="relative inline-block w-12 mr-2 align-middle select-none transition duration-200 ease-in">
                            <input type="checkbox" name="toggle" id="darkModeToggle" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer"/>
                            <label for="darkModeToggle" class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 cursor-pointer"></label>
                        </div>
                        <style>
                            /* Custom styles for the toggle switch */
                            .toggle-checkbox:checked {
                                right: 0;
                                border-color: #3182ce; /* blue-600 */
                            }
                            .toggle-checkbox:checked + .toggle-label {
                                background-color: #3182ce; /* blue-600 */
                            }
                            .toggle-label {
                                transition: background-color 0.2s ease;
                            }
                            .toggle-checkbox {
                                transition: right 0.2s ease, border-color 0.2s ease;
                            }
                        </style>
                    </div>
                </div>

                <div class="card p-6 mb-8">
                    <h3 class="text-2xl font-bold text-gray-800 mb-4">Ubah Kata Sandi</h3>
                    <form id="changePasswordForm" class="space-y-5">
                        <div>
                            <label for="currentPassword" class="block text-sm font-medium text-gray-700 mb-1">Kata Sandi Saat Ini</label>
                            <input type="password" id="currentPassword" required class="block">
                        </div>
                        <div>
                            <label for="newPassword" class="block text-sm font-medium text-gray-700 mb-1">Kata Sandi Baru</label>
                            <input type="password" id="newPassword" required class="block">
                        </div>
                        <div>
                            <label for="confirmNewPassword" class="block text-sm font-medium text-gray-700 mb-1">Konfirmasi Kata Sandi Baru</label>
                            <input type="password" id="confirmNewPassword" required class="block">
                        </div>
                        <p id="passwordMessage" class="text-red-500 text-sm hidden text-center"></p>
                        <button type="submit" class="w-full btn-primary">Ubah Kata Sandi</button>
                    </form>
                </div>

                <div class="card p-6 mb-8">
                    <h3 class="text-2xl font-bold text-gray-800 mb-4">Kelola Kategori</h3>
                    <form id="addCategoryForm" class="flex flex-col sm:flex-row gap-4 mb-4">
                        <input type="text" id="newCategoryName" placeholder="Nama Kategori Baru" required class="flex-grow">
                        <button type="submit" class="btn-primary">Tambah Kategori</button>
                    </form>
                    <div id="categoryList" class="space-y-3">
                        <p class="text-gray-500 text-center">Belum ada kategori.</p>
                    </div>
                </div>

                <div class="card p-6 mb-8">
                    <h3 class="text-2xl font-bold text-gray-800 mb-4">Backup & Pulihkan Data (Lokal)</h3>
                    <p class="text-gray-700 mb-4">Ekspor semua data Anda ke file atau impor dari file yang sudah ada.</p>
                    <div class="flex flex-col sm:flex-row gap-4">
                        <button id="exportAllDataBtn" class="w-full sm:flex-1 btn-primary">Ekspor Semua Data</button>
                        <input type="file" id="importAllDataInput" accept=".json" class="hidden">
                        <label for="importAllDataInput" class="w-full sm:flex-1 btn-secondary cursor-pointer text-center flex items-center justify-center">Impor Semua Data</label>
                    </div>
                </div>

                <div class="card p-6 mb-8">
                    <h3 class="text-2xl font-bold text-gray-800 mb-4">Kirim Semua Transaksi ke WhatsApp</h3>
                    <p class="text-gray-700 mb-4">Klik tombol di bawah untuk mengirim semua detail transaksi Anda ke nomor WhatsApp yang ditentukan.</p>
                    <button id="sendWhatsappSummaryBtn" class="w-full btn-primary">Kirim Semua Transaksi ke WhatsApp</button>
                </div>

                <div class="card p-6">
                    <h3 class="text-2xl font-bold text-gray-800 mb-4">Ekspor Data Transaksi (CSV)</h3>
                    <p class="text-gray-700 mb-4">Unduh semua transaksi Anda dalam format CSV.</p>
                    <button id="exportDataBtn" class="btn-primary">Ekspor Transaksi ke CSV</button>
                </div>

                <div class="card p-6 mt-8 border border-red-300 bg-red-100">
                    <h3 class="text-2xl font-bold mb-4 text-red-700">Hapus Akun</h3>
                    <p class="text-gray-700 mb-4">Menghapus akun Anda akan menghapus semua data Anda secara permanen. Tindakan ini tidak dapat dibatalkan.</p>
                    <button id="deleteAccountBtn" class="w-full btn-danger">Hapus Akun Saya</button>
                </div>
            </section>

            <!-- Help/Chatbot Section -->
            <section id="helpSection" class="hidden">
                <h2 class="text-3xl font-bold text-gray-800 mb-6">Bantuan</h2>
                <div class="card p-6">
                    <h3 class="text-2xl font-bold text-gray-800 mb-4">Asisten Bantuan</h3>
                    <div id="chatDisplay" class="flex flex-col">
                        <!-- Chat messages will be displayed here -->
                        <div class="chat-message bot">Halo! Saya asisten bantuan Anda. Bagaimana saya bisa membantu?</div>
                    </div>
                    <div id="chatOptions" class="flex flex-wrap justify-center gap-2">
                        <!-- Chat options will be dynamically generated here -->
                    </div>
                </div>
            </section>
        </main>

        <!-- Footer -->
        <footer class="bg-gray-900 text-white text-center p-5 text-sm mt-auto shadow-inner">
            &copy; 2025 by Adi Sudrajat. All rights reserved.
        </footer>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirmationModal" class="modal-overlay hidden">
        <div class="modal-content">
            <button class="modal-close-btn" onclick="hideConfirmationModal()">&times;</button>
            <h3 class="text-2xl font-bold text-gray-800 mb-4" id="confirmationModalTitle">Konfirmasi</h3>
            <p id="confirmationModalMessage" class="mb-6 text-gray-700 text-base">Apakah Anda yakin?</p>
            <div class="flex justify-end gap-3">
                <button id="confirmNoBtn" class="btn-secondary">Tidak</button>
                <button id="confirmYesBtn" class="btn-danger">Ya</button>
            </div>
        </div>
    </div>

    <!-- Edit Transaction Modal -->
    <div id="editTransactionModal" class="modal-overlay hidden">
        <div class="modal-content">
            <button class="modal-close-btn" onclick="hideEditTransactionModal()">&times;</button>
            <h3 class="text-2xl font-bold text-gray-800 mb-4">Edit Transaksi</h3>
            <form id="editTransactionForm" class="space-y-5">
                <input type="hidden" id="editTransactionId">
                <div>
                    <label for="editTransactionDate" class="block text-sm font-medium text-gray-700 mb-1">Tanggal</label>
                    <input type="date" id="editTransactionDate" required class="block">
                </div>
                <div>
                    <label for="editTransactionDescription" class="block text-sm font-medium text-gray-700 mb-1">Deskripsi</label>
                    <input type="text" id="editTransactionDescription" required class="block">
                </div>
                <div>
                    <label for="editTransactionAmount" class="block text-sm font-medium text-gray-700 mb-1">Jumlah (Rp)</label>
                    <input type="number" id="editTransactionAmount" required min="1" class="block">
                </div>
                <div>
                    <label for="editTransactionType" class="block text-sm font-medium text-gray-700 mb-1">Tipe</label>
                    <select id="editTransactionType" required class="block">
                        <option value="income">Pemasukan</option>
                        <option value="expense">Pengeluaran</option>
                    </select>
                </div>
                <div>
                    <label for="editTransactionCategory" class="block text-sm font-medium text-gray-700 mb-1">Kategori</label>
                    <select id="editTransactionCategory" required class="block">
                        </select>
                </div>
                <button type="submit" class="w-full btn-primary">Simpan Perubahan</button>
            </form>
        </div>
    </div>

    <!-- JSON Display Modal -->
    <div id="jsonDisplayModal" class="modal-overlay hidden">
        <div class="modal-content">
            <button class="modal-close-btn" onclick="hideJsonDisplayModal()">&times;</button>
            <h3 class="text-2xl font-bold text-gray-800 mb-4">Ekspor Data JSON</h3>
            <p class="text-gray-700 mb-4">Salin teks di bawah ini dan tempelkan ke editor teks di perangkat Anda, lalu simpan sebagai file <code class="bg-gray-100 text-gray-800 px-1 rounded">.json</code>.</p>
            <textarea id="jsonOutput" readonly></textarea>
            <button id="copyJsonBtn" class="btn-primary">Salin ke Clipboard</button>
        </div>
    </div>

    <!-- Forgot Password Modal -->
    <div id="forgotPasswordModal" class="modal-overlay hidden">
        <div class="modal-content">
            <button class="modal-close-btn" onclick="hideForgotPasswordModal()">&times;</button>
            <h3 class="text-2xl font-bold text-gray-800 mb-4">Lupa Kata Sandi</h3>
            <form id="forgotPasswordForm" class="space-y-5">
                <div>
                    <label for="forgotPasswordEmail" class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                    <input type="email" id="forgotPasswordEmail" placeholder="Masukkan email Anda" required class="block">
                </div>
                <p id="forgotPasswordMessage" class="text-red-500 text-sm hidden text-center"></p>
                <button type="submit" class="w-full btn-primary">Kirim Link Reset Kata Sandi</button>
            </form>
        </div>
    </div>

    <!-- Notification Container -->
    <div id="notificationContainer"></div>

    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import {
            getAuth,
            createUserWithEmailAndPassword,
            signInWithEmailAndPassword,
            signOut,
            onAuthStateChanged,
            updatePassword,
            deleteUser as deleteFirebaseAuthUser,
            reauthenticateWithCredential,
            EmailAuthProvider,
            sendPasswordResetEmail,
            sendEmailVerification // Added for email verification
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import {
            getFirestore,
            doc,
            getDoc,
            setDoc,
            addDoc,
            updateDoc,
            deleteDoc,
            onSnapshot,
            collection,
            query,
            where,
            getDocs,
            writeBatch
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase Configuration (provided by the environment)
        const firebaseConfig = {
            apiKey: "AIzaSyDvf_Rg89uX9ODamiUjTCZ-ZTIYA2C7a7w",
            authDomain: "keuanganadi.firebaseapp.com",
            projectId: "keuanganadi",
            storageBucket: "keuanganadi.firebasestorage.app",
            messagingSenderId: "829317955644",
            appId: "1:829317955644:web:ecd350db338c02ab0fc339",
            measurementId: "G-WDNBRP6DB5"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Global variables for Canvas environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        console.log("Using appId for Firestore paths:", appId);
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // DOM Elements
        const sidebar = document.getElementById('sidebar');
        const menuBtn = document.getElementById('menuBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        const authSection = document.getElementById('authSection');
        const authTitle = document.getElementById('authTitle');
        const authForm = document.getElementById('authForm');
        const usernameInput = document.getElementById('username'); // Now email input
        const passwordInput = document.getElementById('password');
        const authSubmitBtn = document.getElementById('authSubmitBtn');
        const authMessage = document.getElementById('authMessage');
        const toggleAuthModeBtn = document.getElementById('toggleAuthMode');
        const forgotPasswordLink = document.getElementById('forgotPasswordLink'); // New: Forgot Password Link

        const dashboardSection = document.getElementById('dashboardSection');
        const dashboardUsernameEl = document.getElementById('dashboardUsername');
        const currentBalanceEl = document.getElementById('currentBalance');
        const totalIncomeEl = document.getElementById('totalIncome');
        const totalExpenseEl = document.getElementById('totalExpense');
        const latestTransactionsEl = document.getElementById('latestTransactions');
        const incomeExpenseChart = document.getElementById('incomeExpenseChart');
        const expenseByCategorySummary = document.getElementById('expenseByCategorySummary');

        const transactionsSection = document.getElementById('transactionsSection');
        const transactionForm = document.getElementById('transactionForm');
        const transactionDateInput = document.getElementById('transactionDate');
        const transactionDescriptionInput = document.getElementById('transactionDescription');
        const transactionAmountInput = document.getElementById('transactionAmount');
        const transactionTypeInput = document.getElementById('transactionType');
        const transactionCategoryInput = document.getElementById('transactionCategory');
        const allTransactionsListEl = document.getElementById('allTransactionsList');
        const transactionSearchInput = document.getElementById('transactionSearchInput');
        const filterTypeSelect = document.getElementById('filterType');
        const filterStartDate = document.getElementById('filterStartDate');
        const filterEndDate = document.getElementById('filterEndDate');
        const sortBySelect = document.getElementById('sortBy');
        const prevPageBtn = document.getElementById('prevPageBtn');
        const nextPageBtn = document.getElementById('nextPageBtn');
        const pageInfo = document.getElementById('pageInfo');

        // New Budgeting Section Elements
        const budgetingSidebarItem = document.getElementById('budgetingSidebarItem');
        const budgetingSection = document.getElementById('budgetingSection');
        const budgetForm = document.getElementById('budgetForm');
        const budgetItemCategorySelect = document.getElementById('budgetItemCategory');
        const budgetAmountInput = document.getElementById('budgetAmount');
        const budgetStartDateInput = document.getElementById('budgetStartDate');
        const budgetEndDateInput = document.getElementById('budgetEndDate');
        const budgetListEl = document.getElementById('budgetList');
        const budgetMessageEl = document.getElementById('budgetMessage');

        const reportsSection = document.getElementById('reportsSection');
        const reportMonthSelect = document.getElementById('reportMonthSelect');
        const reportYearSelect = document.getElementById('reportYearSelect');
        const reportTotalIncomeEl = document.getElementById('reportTotalIncome');
        const reportTotalExpenseEl = document.getElementById('reportTotalExpense');
        const reportNetBalanceEl = document.getElementById('reportNetBalance');
        const reportExpenseByCategory = document.getElementById('reportExpenseByCategory');
        const reportIncomeByCategory = document.getElementById('reportIncomeByCategory');
        const reportTransactionsListEl = document.getElementById('reportTransactionsList');
        const generatePdfReportBtn = document.getElementById('generatePdfReportBtn'); // New PDF button

        // New Chart.js canvas elements
        const monthlySummaryChartCanvas = document.getElementById('monthlySummaryChart');
        const expenseByCategoryChartCanvas = document.getElementById('expenseByCategoryChart');
        const incomeByCategoryChartCanvas = document.getElementById('incomeByCategoryChart');

        let monthlySummaryChartInstance = null; // To store Chart.js instance for monthly summary
        let expenseByCategoryChartInstance = null; // To store Chart.js instance for expense by category
        let incomeByCategoryChartInstance = null; // To store Chart.js instance for income by category

        // Analysis Section Elements
        const analysisSidebarItem = document.getElementById('analysisSidebarItem');
        const analysisSection = document.getElementById('analysisSection');
        const financialTrendsChartCanvas = document.getElementById('financialTrendsChart');
        const topExpenseCategoriesChartCanvas = document.getElementById('topExpenseCategoriesChart');
        const topIncomeCategoriesChartCanvas = document.getElementById('topIncomeCategoriesChart');
        const topExpenseCategoriesSummary = document.getElementById('topExpenseCategoriesSummary');
        const topIncomeCategoriesSummary = document.getElementById('topIncomeCategoriesSummary');

        let financialTrendsChartInstance = null;
        let topExpenseCategoriesChartInstance = null;
        let topIncomeCategoriesChartInstance = null;

        const settingsSection = document.getElementById('settingsSection');
        const changePasswordForm = document.getElementById('changePasswordForm');
        const currentPasswordInput = document.getElementById('currentPassword');
        const newPasswordInput = document.getElementById('newPassword');
        const confirmNewPasswordInput = document.getElementById('confirmNewPassword');
        const passwordMessageEl = document.getElementById('passwordMessage');
        const addCategoryForm = document.getElementById('addCategoryForm');
        const newCategoryNameInput = document.getElementById('newCategoryName');
        const categoryListEl = document.getElementById('categoryList');
        const exportDataBtn = document.getElementById('exportDataBtn');
        const deleteAccountBtn = document.getElementById('deleteAccountBtn'); // New delete account button
        const darkModeToggle = document.getElementById('darkModeToggle'); // New dark mode toggle

        // WhatsApp Send Button
        const sendWhatsappSummaryBtn = document.getElementById('sendWhatsappSummaryBtn');

        // Specific sidebar items to hide/show
        const dashboardSidebarItem = document.getElementById('dashboardSidebarItem');
        const transactionsSidebarItem = document.getElementById('transactionsSidebarItem');
        const reportsSidebarItem = document.getElementById('reportsSidebarItem');
        const settingsSidebarItem = document.getElementById('settingsSidebarItem');
        const helpSidebarItem = document.getElementById('helpSidebarItem'); // New help sidebar item

        const sidebarItems = document.querySelectorAll('.sidebar-item');

        // Modal Elements
        const confirmationModal = document.getElementById('confirmationModal');
        const confirmationModalTitle = document.getElementById('confirmationModalTitle');
        const confirmationModalMessage = document.getElementById('confirmationModalMessage');
        const confirmYesBtn = document.getElementById('confirmYesBtn');
        const confirmNoBtn = document.getElementById('confirmNoBtn');

        const editTransactionModal = document.getElementById('editTransactionModal');
        const editTransactionForm = document.getElementById('editTransactionForm');
        const editTransactionIdInput = document.getElementById('editTransactionId');
        const editTransactionDateInput = document.getElementById('editTransactionDate');
        const editTransactionDescriptionInput = document.getElementById('editTransactionDescription');
        const editTransactionAmountInput = document.getElementById('editTransactionAmount');
        const editTransactionTypeInput = document.getElementById('editTransactionType');
        const editTransactionCategoryInput = document.getElementById('editTransactionCategory');

        // New JSON Display Modal Elements
        const jsonDisplayModal = document.getElementById('jsonDisplayModal');
        const jsonOutput = document.getElementById('jsonOutput');
        const copyJsonBtn = document.getElementById('copyJsonBtn');

        // New Forgot Password Modal Elements
        const forgotPasswordModal = document.getElementById('forgotPasswordModal');
        const forgotPasswordEmailInput = document.getElementById('forgotPasswordEmail');
        const forgotPasswordMessageEl = document.getElementById('forgotPasswordMessage');
        const forgotPasswordForm = document.getElementById('forgotPasswordForm');

        // Notification Container
        const notificationContainer = document.getElementById('notificationContainer');

        // New Import/Export Buttons
        const exportAllDataBtn = document.getElementById('exportAllDataBtn');
        const importAllDataInput = document.getElementById('importAllDataInput');

        // Chatbot Elements
        const helpSection = document.getElementById('helpSection');
        const chatDisplay = document.getElementById('chatDisplay');
        const chatOptions = document.getElementById('chatOptions');

        // State Variables
        let isLoggedIn = false;
        let currentFirebaseUser = null; // Stores the Firebase User object (auth.currentUser)
        let authMode = 'login'; // 'login' or 'register'

        // Pagination variables
        const transactionsPerPage = 10;
        let currentPage = 1;
        let filteredTransactions = []; // To store transactions after search/filter for pagination

        // Listeners for Firestore data (unsubscribing when user logs out)
        let unsubscribeTransactions = null;
        let unsubscribeCategories = null;
        let unsubscribeBudgets = null;

        // --- Utility Functions ---

        // Function to format number as Rupiah
        function formatRupiah(amount) {
            return new Intl.NumberFormat('id-ID', {
                style: 'currency',
                currency: 'IDR',
                minimumFractionDigits: 0
            }).format(amount);
        }

        // Function to show a message (e.g., error, success)
        function showMessage(element, message, isError = true) {
            element.textContent = message;
            element.classList.remove('hidden');
            element.classList.toggle('text-red-500', isError);
            element.classList.toggle('text-green-500', !isError);
        }

        // Function to show a notification
        function showNotification(message, type = 'success', duration = 3000) {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            notificationContainer.appendChild(notification);

            setTimeout(() => {
                notification.remove();
            }, duration);
        }

        // --- Dark Mode Functionality ---
        function enableDarkMode() {
            document.body.classList.add('dark-mode');
            localStorage.setItem('darkMode', 'enabled');
        }

        function disableDarkMode() {
            document.body.classList.remove('dark-mode');
            localStorage.setItem('darkMode', 'disabled');
        }

        function toggleDarkMode() {
            if (document.body.classList.contains('dark-mode')) {
                disableDarkMode();
            } else {
                enableDarkMode();
            }
            // Re-render charts to update colors if they are visible
            if (document.getElementById('reportsSection').classList.contains('hidden') === false) {
                 renderReports();
            }
            if (document.getElementById('analysisSection').classList.contains('hidden') === false) {
                renderAnalysis();
            }
        }

        // Initialize dark mode based on local storage
        if (localStorage.getItem('darkMode') === 'enabled') {
            enableDarkMode();
            darkModeToggle.checked = true;
        } else {
            disableDarkMode();
            darkModeToggle.checked = false;
        }

        // --- Authentication Functions ---

        // Firebase Auth State Listener
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                // Check if email is verified
                if (user.emailVerified) {
                    isLoggedIn = true;
                    currentFirebaseUser = user;
                    showSection('dashboardSection');
                    dashboardUsernameEl.textContent = user.email; // Display email as username
                    sidebarUsername.textContent = user.email; // Display email as username
                    setupFirestoreListeners(user.uid); // Setup listeners for regular users
                } else {
                    // If email is not verified, sign out and show message
                    await signOut(auth);
                    isLoggedIn = false;
                    currentFirebaseUser = null;
                    showSection('authSection');
                    unsubscribeAllFirestoreListeners();
                    showMessage(authMessage, 'Email Anda belum diverifikasi. Silakan cek kotak masuk Anda untuk tautan verifikasi.', true);
                    showNotification('Email Anda belum diverifikasi. Silakan cek kotak masuk Anda untuk tautan verifikasi.', 'error', 5000);
                }
            } else {
                isLoggedIn = false;
                currentFirebaseUser = null;
                showSection('authSection');
                unsubscribeAllFirestoreListeners(); // Unsubscribe on logout
            }
            updateUIBasedOnAuth();
        });

        async function handleAuth(event) {
            event.preventDefault();
            authMessage.classList.add('hidden'); // Hide previous message immediately
            const email = usernameInput.value.trim(); // Now email
            const password = passwordInput.value.trim();

            if (!email || !password) {
                showMessage(authMessage, 'Email dan kata sandi tidak boleh kosong.', true);
                showNotification('Email dan kata sandi tidak boleh kosong.', 'error');
                return;
            }

            try {
                if (authMode === 'register') {
                    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                    // Send email verification
                    await sendEmailVerification(userCredential.user);

                    // Initialize user data in Firestore
                    await setDoc(doc(db, `artifacts/${appId}/users/${userCredential.user.uid}/metadata`, 'categories'), {
                        list: ['Makanan', 'Transportasi', 'Gaji', 'Hiburan', 'Tagihan', 'Lain-lain']
                    });
                    await setDoc(doc(db, `artifacts/${appId}/users/${userCredential.user.uid}/metadata`, 'budgets'), {
                        list: []
                    });

                    showMessage(authMessage, 'Registrasi berhasil! Link verifikasi telah dikirim ke email Anda. Silakan verifikasi email Anda sebelum login.', false);
                    showNotification('Registrasi berhasil! Link verifikasi telah dikirim ke email Anda. Silakan verifikasi email Anda sebelum login.', 'success', 5000);
                    // Switch to login mode after successful registration
                    authMode = 'login';
                    authTitle.textContent = 'Login';
                    authSubmitBtn.textContent = 'Login';
                    toggleAuthModeBtn.textContent = 'Daftar di sini';
                    usernameInput.value = ''; // Clear fields after successful registration
                    passwordInput.value = ''; // Clear fields after successful registration

                } else { // Login mode
                    const userCredential = await signInWithEmailAndPassword(auth, email, password);
                    // Check email verification status after successful login
                    if (!userCredential.user.emailVerified) {
                        await signOut(auth); // Sign out unverified user
                        showMessage(authMessage, 'Email Anda belum diverifikasi. Silakan cek kotak masuk Anda untuk tautan verifikasi.', true);
                        showNotification('Email Anda belum diverifikasi. Silakan cek kotak masuk Anda untuk tautan verifikasi.', 'error', 5000);
                        return; // Stop further execution
                    }
                    showMessage(authMessage, 'Login berhasil!', false);
                    showNotification('Login berhasil!', 'success');
                    // onAuthStateChanged will handle showing the correct section
                }
            } catch (error) {
                console.error("Authentication error:", error);
                let errorMessage = 'Terjadi kesalahan otentikasi.';
                if (error.code === 'auth/email-already-in-use') {
                    errorMessage = 'Email sudah terdaftar. Silakan gunakan email lain atau login.';
                } else if (error.code === 'auth/invalid-email') {
                    errorMessage = 'Format email tidak valid.';
                } else if (error.code === 'auth/weak-password') {
                    errorMessage = 'Kata sandi terlalu lemah (minimal 6 karakter).';
                } else if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password') {
                    errorMessage = 'Email atau kata sandi salah.';
                }
                showMessage(authMessage, errorMessage, true);
                showNotification(errorMessage, 'error');
            }
        }

        async function handleLogout() {
            try {
                await signOut(auth);
                showNotification('Anda telah logout.', 'success');
                // onAuthStateChanged will handle showing the auth section
            } catch (error) {
                console.error("Logout error:", error);
                showNotification('Gagal logout. Silakan coba lagi.', 'error');
            }
            // Reset form fields
            usernameInput.value = '';
            passwordInput.value = '';
        }

        function updateUIBasedOnAuth() {
            if (isLoggedIn) {
                authSection.classList.add('hidden');
                sidebar.classList.remove('hidden');
                logoutBtn.classList.remove('hidden');
                // Ensure sidebar is open on desktop, hidden on mobile initially
                if (window.innerWidth < 768) {
                    sidebar.classList.remove('open');
                } else {
                    sidebar.classList.add('open');
                }

                dashboardSidebarItem.classList.remove('hidden');
                transactionsSidebarItem.classList.remove('hidden');
                budgetingSidebarItem.classList.remove('hidden');
                reportsSidebarItem.classList.remove('hidden');
                analysisSidebarItem.classList.remove('hidden');
                settingsSidebarItem.classList.remove('hidden');
                helpSidebarItem.classList.remove('hidden');
            } else {
                authSection.classList.remove('hidden');
                sidebar.classList.add('hidden');
                logoutBtn.classList.add('hidden');
                // Hide all sidebar items on logout
                dashboardSidebarItem.classList.add('hidden');
                transactionsSidebarItem.classList.add('hidden');
                budgetingSidebarItem.classList.add('hidden');
                reportsSidebarItem.classList.add('hidden');
                analysisSidebarItem.classList.add('hidden');
                settingsSidebarItem.classList.add('hidden');
                helpSidebarItem.classList.add('hidden');

                // Hide all other sections
                document.querySelectorAll('main > section:not(#authSection)').forEach(section => {
                    section.classList.add('hidden');
                });
                sidebarUsername.textContent = ''; // Clear username in sidebar
            }
        }

        // --- Firestore Data Management ---

        // Setup real-time listeners for current user's data
        function setupFirestoreListeners(uid) {
            console.log("Setting up Firestore listeners for UID:", uid); // Log when listeners are set up
            // Unsubscribe existing listeners first
            unsubscribeAllFirestoreListeners();

            // Transactions listener
            const transactionsRef = collection(db, `artifacts/${appId}/users/${uid}/transactions`);
            unsubscribeTransactions = onSnapshot(transactionsRef, (snapshot) => {
                const transactions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                console.log("Firestore Transactions updated:", transactions); // Log fetched transactions
                window._userTransactions = transactions; // Make it accessible globally for other functions
                renderDashboard();
                renderTransactions();
                renderReports();
                renderAnalysis();
                renderBudgets(); // Re-render budgets as they depend on transactions
            }, (error) => {
                console.error("Error fetching transactions:", error);
                showNotification('Gagal memuat transaksi. Silakan coba lagi.', 'error');
            });

            // Categories listener
            const categoriesDocRef = doc(db, `artifacts/${appId}/users/${uid}/metadata`, 'categories');
            unsubscribeCategories = onSnapshot(categoriesDocRef, (docSnap) => {
                const categories = docSnap.exists() ? docSnap.data().list : ['Makanan', 'Transportasi', 'Gaji', 'Hiburan', 'Tagihan', 'Lain-lain'];
                console.log("Firestore Categories updated:", categories); // Log fetched categories
                window._userCategories = categories;
                renderCategoryOptions(transactionCategoryInput);
                renderCategoryOptions(editTransactionCategoryInput);
                renderCategoryOptions(budgetItemCategorySelect);
                renderManageCategories();
            }, (error) => {
                console.error("Error fetching categories:", error);
                showNotification('Gagal memuat kategori. Silakan coba lagi.', 'error');
            });

            // Budgets listener
            const budgetsDocRef = doc(db, `artifacts/${appId}/users/${uid}/metadata`, 'budgets');
            unsubscribeBudgets = onSnapshot(budgetsDocRef, (docSnap) => {
                const budgets = docSnap.exists() ? docSnap.data().list : [];
                console.log("Firestore Budgets updated:", budgets); // Log fetched budgets
                window._userBudgets = budgets;
                renderBudgets();
            }, (error) => {
                console.error("Error fetching budgets:", error);
                showNotification('Gagal memuat anggaran. Silakan coba lagi.', 'error');
            });
        }

        // Unsubscribe all listeners (on logout)
        function unsubscribeAllFirestoreListeners() {
            if (unsubscribeTransactions) unsubscribeTransactions();
            if (unsubscribeCategories) unsubscribeCategories();
            if (unsubscribeBudgets) unsubscribeBudgets();
            window._userTransactions = [];
            window._userCategories = [];
            window._userBudgets = [];
            console.log("All Firestore listeners unsubscribed.");
        }

        // Helper to get current user's UID
        function getCurrentUserId() {
            return currentFirebaseUser ? currentFirebaseUser.uid : null;
        }

        // Functions to interact with Firestore data
        function getUserTransactions() {
            return window._userTransactions || [];
        }

        async function addTransactionToFirestore(transaction) {
            const userId = getCurrentUserId();
            if (!userId) {
                showNotification('Anda harus login untuk menambahkan transaksi.', 'error');
                return;
            }
            try {
                await addDoc(collection(db, `artifacts/${appId}/users/${userId}/transactions`), transaction);
                console.log("Transaction added to Firestore:", transaction);
            } catch (error) {
                console.error("Error adding transaction:", error);
                showNotification('Gagal menambahkan transaksi. Silakan coba lagi.', 'error');
            }
        }

        async function updateTransactionInFirestore(id, updatedTransaction) {
            const userId = getCurrentUserId();
            if (!userId) {
                showNotification('Anda harus login untuk memperbarui transaksi.', 'error');
                return;
            }
            try {
                await setDoc(doc(db, `artifacts/${appId}/users/${userId}/transactions`, id), updatedTransaction);
                console.log("Transaction updated in Firestore:", id, updatedTransaction);
            } catch (error) {
                console.error("Error updating transaction:", error);
                showNotification('Gagal memperbarui transaksi. Silakan coba lagi.', 'error');
            }
        }

        async function deleteTransactionFromFirestore(id) {
            const userId = getCurrentUserId();
            if (!userId) {
                showNotification('Anda harus login untuk menghapus transaksi.', 'error');
                return;
            }
            try {
                await deleteDoc(doc(db, `artifacts/${appId}/users/${userId}/transactions`, id));
                console.log("Transaction deleted from Firestore:", id);
            } catch (error) {
                console.error("Error deleting transaction:", error);
                showNotification('Gagal menghapus transaksi. Silakan coba lagi.', 'error');
            }
        }

        function getUserCategories() {
            return window._userCategories || [];
        }

        async function saveUserCategoriesToFirestore(categories) {
            const userId = getCurrentUserId();
            if (!userId) {
                showNotification('Anda harus login untuk menyimpan kategori.', 'error');
                return;
            }
            try {
                await setDoc(doc(db, `artifacts/${appId}/users/${userId}/metadata`, 'categories'), { list: categories });
                console.log("Categories saved to Firestore:", categories);
            } catch (error) {
                console.error("Error saving categories:", error);
                showNotification('Gagal menyimpan kategori. Silakan coba lagi.', 'error');
            }
        }

        function getUserBudgets() {
            return window._userBudgets || [];
        }

        async function saveUserBudgetsToFirestore(budgets) {
            const userId = getCurrentUserId();
            if (!userId) {
                showNotification('Anda harus login untuk menyimpan anggaran.', 'error');
                return;
            }
            try {
                await setDoc(doc(db, `artifacts/${appId}/users/${userId}/metadata`, 'budgets'), { list: budgets });
                console.log("Budgets saved to Firestore:", budgets);
            } catch (error) {
                console.error("Error saving budgets:", error);
                showNotification('Gagal menyimpan anggaran. Silakan coba lagi.', 'error');
            }
        }

        // --- Section Management ---

        function showSection(sectionId) {
            document.querySelectorAll('main > section').forEach(section => {
                section.classList.add('hidden');
            });
            document.getElementById(sectionId).classList.remove('hidden');

            // Update active sidebar item
            sidebarItems.forEach(item => {
                item.classList.remove('active');
                if (item.dataset.section + 'Section' === sectionId) {
                    item.classList.add('active');
                }
            });

            // Close sidebar on mobile after navigating
            if (window.innerWidth < 768) {
                sidebar.classList.remove('open');
            }

            // Update data for the displayed section
            if (sectionId === 'dashboardSection') {
                renderDashboard();
            } else if (sectionId === 'transactionsSection') {
                renderCategoryOptions(transactionCategoryInput);
                currentPage = 1; // Reset pagination
                renderTransactions();
            } else if (sectionId === 'budgetingSection') {
                renderCategoryOptions(budgetItemCategorySelect);
                renderBudgets();
            }
            else if (sectionId === 'reportsSection') {
                populateReportYears();
                renderReports();
            } else if (sectionId === 'analysisSection') {
                renderAnalysis();
            } else if (sectionId === 'settingsSection') {
                renderManageCategories();
            } else if (sectionId === 'helpSection') {
                startChatbot();
            }
        }

        // --- Transaction Management ---

        async function addTransaction(event) {
            event.preventDefault();
            const date = transactionDateInput.value;
            const description = transactionDescriptionInput.value.trim();
            const amount = parseFloat(transactionAmountInput.value);
            const type = transactionTypeInput.value;
            const category = transactionCategoryInput.value;

            if (!date || !description || isNaN(amount) || amount <= 0 || !category) {
                showMessage(authMessage, 'Semua field harus diisi dengan benar.');
                showNotification('Semua field harus diisi dengan benar.', 'error');
                return;
            }

            // Budgeting check for expense transactions
            if (type === 'expense') {
                const budgets = getUserBudgets();
                const activeBudgets = budgets.filter(b => {
                    const budgetStart = new Date(b.startDate);
                    const budgetEnd = new Date(b.endDate);
                    const transactionDate = new Date(date);
                    return b.category === category && transactionDate >= budgetStart && transactionDate <= budgetEnd;
                });

                if (activeBudgets.length > 0) {
                    const currentExpensesForCategory = getUserTransactions().filter(t =>
                        t.type === 'expense' &&
                        t.category === category &&
                        new Date(t.date) >= new Date(activeBudgets[0].startDate) &&
                        new Date(t.date) <= new Date(activeBudgets[0].endDate)
                    ).reduce((sum, t) => sum + t.amount, 0);

                    const budgetLimit = activeBudgets[0].amount;
                    const remainingBudget = budgetLimit - currentExpensesForCategory;

                    if (amount > remainingBudget) {
                        const confirm = await new Promise(resolve => {
                            showConfirmationModal(`Transaksi ini (${formatRupiah(amount)}) akan melebihi anggaran Anda untuk kategori '${category}' (Sisa anggaran: ${formatRupiah(remainingBudget)}). Lanjutkan?`, () => resolve(true), () => resolve(false));
                        });
                        if (!confirm) {
                            showNotification('Transaksi dibatalkan karena melebihi anggaran.', 'info');
                            return;
                        }
                    }
                }
            }

            const newTransaction = {
                date: date,
                description: description,
                amount: amount,
                type: type,
                category: category
            };

            await addTransactionToFirestore(newTransaction);

            showMessage(authMessage, 'Transaksi berhasil ditambahkan!', false);
            showNotification('Transaksi berhasil ditambahkan!', 'success');
            transactionForm.reset(); // Clear form
            const today = new Date().toISOString().split('T')[0];
            transactionDateInput.value = today; // Reset date to today
            // UI will update via Firestore listener (onSnapshot)
        }

        async function deleteTransaction(id) {
            confirmAction('Apakah Anda yakin ingin menghapus transaksi ini?', async () => {
                await deleteTransactionFromFirestore(id);
                showMessage(authMessage, 'Transaksi berhasil dihapus!', false);
                showNotification('Transaksi berhasil dihapus!', 'success');
                // UI will update via Firestore listener (onSnapshot)
            });
        }

        async function editTransaction(id) {
            const transactions = getUserTransactions();
            const transactionToEdit = transactions.find(t => t.id === id);

            if (transactionToEdit) {
                editTransactionIdInput.value = transactionToEdit.id;
                editTransactionDateInput.value = transactionToEdit.date;
                editTransactionDescriptionInput.value = transactionToEdit.description;
                editTransactionAmountInput.value = transactionToEdit.amount;
                editTransactionTypeInput.value = transactionToEdit.type;
                renderCategoryOptions(editTransactionCategoryInput); // Populate categories for edit form
                editTransactionCategoryInput.value = transactionToEdit.category;

                showEditTransactionModal();
            }
        }

        async function updateTransaction(event) {
            event.preventDefault();
            const id = editTransactionIdInput.value; // ID is string from Firestore
            const date = editTransactionDateInput.value;
            const description = editTransactionDescriptionInput.value.trim();
            const amount = parseFloat(editTransactionAmountInput.value);
            const type = editTransactionTypeInput.value;
            const category = editTransactionCategoryInput.value;

            if (!date || !description || isNaN(amount) || amount <= 0 || !category) {
                showMessage(authMessage, 'Semua field harus diisi dengan benar.');
                showNotification('Semua field harus diisi dengan benar.', 'error');
                return;
            }

            const updatedTransaction = { date, description, amount, type, category };

            await updateTransactionInFirestore(id, updatedTransaction);

            showMessage(authMessage, 'Transaksi berhasil diperbarui!', false);
            showNotification('Transaksi berhasil diperbarui!', 'success');
            hideEditTransactionModal();
            // UI will update via Firestore listener (onSnapshot)
        }

        // --- Category Management ---

        function renderCategoryOptions(selectElement) {
            const categories = getUserCategories();
            selectElement.innerHTML = ''; // Clear existing options
            if (categories.length === 0) {
                const option = document.createElement('option');
                option.value = '';
                option.textContent = 'Tidak ada kategori';
                selectElement.appendChild(option);
                selectElement.disabled = true;
                return;
            }
            selectElement.disabled = false;
            categories.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat;
                option.textContent = cat;
                selectElement.appendChild(option);
            });
        }

        async function addCategory(event) {
            event.preventDefault();
            const newCategory = newCategoryNameInput.value.trim();
            if (!newCategory) {
                showMessage(passwordMessageEl, 'Nama kategori tidak boleh kosong.', true);
                showNotification('Nama kategori tidak boleh kosong.', 'error');
                return;
            }

            let categories = getUserCategories();
            if (categories.includes(newCategory)) {
                showMessage(passwordMessageEl, 'Kategori ini sudah ada.', true);
                showNotification('Kategori ini sudah ada.', 'error');
                return;
            }

            categories.push(newCategory);
            await saveUserCategoriesToFirestore(categories);
            showMessage(passwordMessageEl, 'Kategori berhasil ditambahkan!', false);
            showNotification('Kategori berhasil ditambahkan!', 'success');
            newCategoryNameInput.value = '';
            // UI will update via Firestore listener (onSnapshot)
        }

        async function deleteCategory(categoryToDelete) {
            confirmAction(`Apakah Anda yakin ingin menghapus kategori "${categoryToDelete}"? Transaksi dan anggaran yang terkait tidak akan terhapus, tetapi kategorinya akan dialihkan ke 'Lain-lain'.`, async () => {
                let categories = getUserCategories();
                categories = categories.filter(cat => cat !== categoryToDelete);

                // Update transactions that used this category
                let transactions = getUserTransactions();
                const transactionUpdates = transactions.filter(t => t.category === categoryToDelete).map(t => {
                    const updatedT = { ...t, category: 'Lain-lain' };
                    return updateTransactionInFirestore(t.id, updatedT);
                });
                await Promise.all(transactionUpdates);

                // Update budgets that used this category
                let budgets = getUserBudgets();
                budgets.forEach(b => {
                    if (b.category === categoryToDelete) {
                        b.category = 'Lain-lain'; // Assign to a default or 'Uncategorized'
                    }
                });
                await saveUserBudgetsToFirestore(budgets);

                await saveUserCategoriesToFirestore(categories); // Save updated categories last

                showMessage(passwordMessageEl, 'Kategori berhasil dihapus!', false);
                showNotification('Kategori berhasil dihapus!', 'success');
                // UI will update via Firestore listener (onSnapshot)
            });
        }

        function renderManageCategories() {
            const categories = getUserCategories();
            categoryListEl.innerHTML = '';
            if (categories.length === 0) {
                categoryListEl.innerHTML = '<p class="text-gray-500 text-center">Belum ada kategori.</p>';
            } else {
                categories.forEach(cat => {
                    const categoryDiv = document.createElement('div');
                    categoryDiv.className = 'flex items-center justify-between p-3 rounded-lg bg-gray-50 border border-gray-200';
                    categoryDiv.innerHTML = `
                        <span class="font-medium text-gray-700">${cat}</span>
                        <button class="btn-danger text-xs px-3 py-1.5" onclick="deleteCategory('${cat}')">Hapus</button>
                    `;
                    categoryListEl.appendChild(categoryDiv);
                });
            }
        }

        // --- Budgeting Functions ---

        async function addBudget(event) {
            event.preventDefault();
            const category = budgetItemCategorySelect.value;
            const amount = parseFloat(budgetAmountInput.value);
            const startDate = budgetStartDateInput.value;
            const endDate = budgetEndDateInput.value;

            if (!category || isNaN(amount) || amount <= 0 || !startDate || !endDate) {
                showMessage(budgetMessageEl, 'Semua field harus diisi dengan benar.', true);
                showNotification('Semua field harus diisi dengan benar.', 'error');
                return;
            }

            if (new Date(startDate) > new Date(endDate)) {
                showMessage(budgetMessageEl, 'Tanggal mulai tidak boleh lebih lambat dari tanggal akhir.', true);
                showNotification('Tanggal mulai tidak boleh lebih lambat dari tanggal akhir.', 'error');
                return;
            }

            let budgets = getUserBudgets();

            // Check for overlapping budgets for the same category
            const overlappingBudget = budgets.find(b =>
                b.category === category &&
                ((new Date(startDate) <= new Date(b.endDate) && new Date(endDate) >= new Date(b.startDate)))
            );

            if (overlappingBudget) {
                showMessage(budgetMessageEl, `Sudah ada anggaran untuk kategori '${category}' yang tumpang tindih dengan periode ini.`, true);
                showNotification(`Anggaran untuk '${category}' tumpang tindih.`, 'error');
                return;
            }

            const newBudget = {
                id: Date.now(), // Use timestamp as ID for local uniqueness before saving
                category,
                amount,
                startDate,
                endDate
            };

            budgets.push(newBudget);
            await saveUserBudgetsToFirestore(budgets);
            showMessage(budgetMessageEl, 'Anggaran berhasil ditambahkan!', false);
            showNotification('Anggaran berhasil ditambahkan!', 'success');
            budgetForm.reset();
            // UI will update via Firestore listener (onSnapshot)
        }

        async function deleteBudget(id) {
            confirmAction('Apakah Anda yakin ingin menghapus anggaran ini?', async () => {
                let budgets = getUserBudgets();
                budgets = budgets.filter(b => b.id !== id);
                await saveUserBudgetsToFirestore(budgets);
                showNotification('Anggaran berhasil dihapus!', 'success');
                // UI will update via Firestore listener (onSnapshot)
            });
        }

        function renderBudgets() {
            const budgets = getUserBudgets();
            const transactions = getUserTransactions();
            budgetListEl.innerHTML = '';

            if (budgets.length === 0) {
                budgetListEl.innerHTML = '<p class="text-gray-500 text-center">Belum ada anggaran yang ditetapkan.</p>';
                return;
            }

            const today = new Date();
            today.setHours(0, 0, 0, 0); // Normalize today's date to start of day

            budgets.sort((a, b) => new Date(a.startDate) - new Date(b.startDate)); // Sort by start date

            budgets.forEach(budget => {
                const budgetStart = new Date(budget.startDate);
                const budgetEnd = new Date(budget.endDate);
                budgetEnd.setHours(23, 59, 59, 999); // Normalize end date to end of day

                const expensesForBudget = transactions.filter(t =>
                    t.type === 'expense' &&
                    t.category === budget.category &&
                    new Date(t.date) >= budgetStart &&
                    new Date(t.date) <= budgetEnd
                ).reduce((sum, t) => sum + t.amount, 0);

                const remainingAmount = budget.amount - expensesForBudget;
                const percentageUsed = (expensesForBudget / budget.amount) * 100;

                let statusText = '';
                let statusColor = 'text-gray-600';
                let progressBarColor = 'bg-blue-400';

                if (today > budgetEnd) {
                    statusText = 'Berakhir';
                    statusColor = 'text-gray-500';
                    progressBarColor = 'bg-gray-400';
                } else if (today < budgetStart) {
                    statusText = 'Mendatang';
                    statusColor = 'text-blue-500';
                    progressBarColor = 'bg-blue-200';
                } else if (remainingAmount <= 0) {
                    statusText = 'Anggaran Habis!';
                    statusColor = 'text-red-500 font-bold';
                    progressBarColor = 'bg-red-500';
                } else if (percentageUsed >= 75) {
                    statusText = 'Hampir Habis!';
                    statusColor = 'text-orange-500 font-bold';
                    progressBarColor = 'bg-orange-400';
                } else {
                    statusText = 'Aktif';
                    statusColor = 'text-green-500';
                    progressBarColor = 'bg-green-400';
                }

                const budgetDiv = document.createElement('div');
                budgetDiv.className = 'card p-4 mb-4';
                budgetDiv.innerHTML = `
                    <div class="flex justify-between items-center mb-2">
                        <h4 class="text-xl font-semibold text-gray-800">${budget.category}</h4>
                        <button class="btn-danger text-xs px-3 py-1.5" onclick="deleteBudget(${budget.id})">Hapus</button>
                    </div>
                    <p class="text-gray-700 text-sm">Periode: ${budget.startDate} s/d ${budget.endDate}</p>
                    <p class="text-lg font-medium text-gray-800 mt-2">Anggaran: ${formatRupiah(budget.amount)}</p>
                    <p class="text-lg font-medium text-gray-800">Terpakai: <span class="text-expense">${formatRupiah(expensesForBudget)}</span></p>
                    <p class="text-lg font-medium text-gray-800">Sisa: <span class="${remainingAmount <= 0 ? 'text-red-500' : 'text-green-500'}">${formatRupiah(remainingAmount)}</span></p>
                    <p class="text-sm mt-1 ${statusColor}">Status: ${statusText}</p>
                    <div class="w-full bg-gray-200 rounded-full h-2.5 mt-3">
                        <div class="${progressBarColor} h-2.5 rounded-full" style="width: ${Math.min(100, percentageUsed)}%;"></div>
                    </div>
                    <p class="text-xs text-gray-500 text-right mt-1">${percentageUsed.toFixed(2)}% Terpakai</p>
                `;
                budgetListEl.appendChild(budgetDiv);
            });
        }


        // --- Password Change ---

        async function handleChangePassword(event) {
            event.preventDefault();
            const currentPass = currentPasswordInput.value;
            const newPass = newPasswordInput.value;
            const confirmNewPass = confirmNewPasswordInput.value;

            if (!currentFirebaseUser) {
                showMessage(passwordMessageEl, 'Anda harus login untuk mengubah kata sandi.', true);
                showNotification('Anda harus login untuk mengubah kata sandi.', 'error');
                return;
            }

            if (!currentPass || !newPass || !confirmNewPass) {
                showMessage(passwordMessageEl, 'Semua field harus diisi.', true);
                showNotification('Semua field harus diisi.', 'error');
                return;
            }

            if (newPass !== confirmNewPass) {
                showMessage(passwordMessageEl, 'Kata sandi baru tidak cocok dengan konfirmasi.', true);
                showNotification('Kata sandi baru tidak cocok dengan konfirmasi.', 'error');
                return;
            }

            if (newPass.length < 6) {
                showMessage(passwordMessageEl, 'Kata sandi baru minimal 6 karakter.', true);
                showNotification('Kata sandi baru minimal 6 karakter.', 'error');
                return;
            }

            try {
                // Re-authenticate user before updating password
                const credential = EmailAuthProvider.credential(currentFirebaseUser.email, currentPass);
                await reauthenticateWithCredential(currentFirebaseUser, credential);
                await updatePassword(currentFirebaseUser, newPass);
                showMessage(passwordMessageEl, 'Kata sandi berhasil diubah!', false);
                showNotification('Kata sandi berhasil diubah!', 'success');
                changePasswordForm.reset();
            } catch (error) {
                console.error("Error changing password:", error);
                let errorMessage = 'Gagal mengubah kata sandi.';
                if (error.code === 'auth/wrong-password') {
                    errorMessage = 'Kata sandi saat ini salah.';
                } else if (error.code === 'auth/requires-recent-login') {
                    errorMessage = 'Untuk alasan keamanan, silakan login ulang dan coba lagi.';
                } else if (error.code === 'auth/invalid-credential') {
                    errorMessage = 'Kredensial saat ini tidak valid. Silakan login ulang.';
                }
                showMessage(passwordMessageEl, errorMessage, true);
                showNotification(errorMessage, 'error');
            }
        }

        // --- Local Data Import/Export ---

        async function exportAllData() {
            if (!currentFirebaseUser) {
                showNotification('Anda harus login untuk mengekspor data.', 'error');
                return;
            }

            const userId = currentFirebaseUser.uid;
            try {
                const transactionsSnapshot = await getDocs(collection(db, `artifacts/${appId}/users/${userId}/transactions`));
                const transactions = transactionsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                const categoriesDoc = await getDoc(doc(db, `artifacts/${appId}/users/${userId}/metadata`, 'categories'));
                const categories = categoriesDoc.exists() ? categoriesDoc.data().list : [];

                const budgetsDoc = await getDoc(doc(db, `artifacts/${appId}/users/${userId}/metadata`, 'budgets'));
                const budgets = budgetsDoc.exists() ? budgetsDoc.data().list : [];

                const dataToExport = {
                    transactions,
                    categories,
                    budgets
                };

                const dataStr = JSON.stringify(dataToExport, null, 2); // Pretty print JSON

                jsonOutput.value = dataStr;
                showJsonDisplayModal();
                showNotification('Salin data JSON dari jendela yang muncul dan simpan secara manual.', 'info', 5000);

            } catch (error) {
                console.error("Error exporting data:", error);
                showNotification('Gagal mengekspor data. Silakan coba lagi.', 'error');
            }
        }

        async function importAllData(event) {
            const file = event.target.files[0];
            if (!file) {
                return;
            }

            if (!currentFirebaseUser) {
                showNotification('Anda harus login untuk mengimpor data.', 'error');
                return;
            }

            if (!file.name.toLowerCase().endsWith('.json')) {
                showNotification('Hanya file JSON yang diizinkan.', 'error');
                return;
            }

            const reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);

                    if (!importedData || !Array.isArray(importedData.transactions) || !Array.isArray(importedData.categories)) {
                        showNotification('Format file JSON tidak valid. Data transaksi atau kategori tidak ditemukan.', 'error');
                        return;
                    }

                    const confirmImport = await new Promise(resolve => {
                        showConfirmationModal('Apakah Anda yakin ingin mengimpor data ini? Ini akan menimpa semua data Anda saat ini.', () => resolve(true), () => resolve(false));
                    });

                    if (!confirmImport) {
                        showNotification('Impor data dibatalkan.', 'info');
                        return;
                    }

                    const userId = currentFirebaseUser.uid;
                    const batch = writeBatch(db);

                    // Delete existing transactions in a batch
                    const existingTransactionsSnapshot = await getDocs(collection(db, `artifacts/${appId}/users/${userId}/transactions`));
                    existingTransactionsSnapshot.docs.forEach(doc => {
                        batch.delete(doc.ref);
                    });

                    // Add new transactions in a batch
                    for (const t of importedData.transactions) {
                        const newDocRef = doc(collection(db, `artifacts/${appId}/users/${userId}/transactions`)); // Let Firestore generate ID
                        batch.set(newDocRef, {
                            date: t.date,
                            description: t.description,
                            amount: t.amount,
                            type: t.type,
                            category: t.category
                        });
                    }

                    // Import categories
                    batch.set(doc(db, `artifacts/${appId}/users/${userId}/metadata`, 'categories'), {
                        list: importedData.categories || ['Makanan', 'Transportasi', 'Gaji', 'Hiburan', 'Tagihan', 'Lain-lain']
                    });

                    // Import budgets
                    batch.set(doc(db, `artifacts/${appId}/users/${userId}/metadata`, 'budgets'), {
                        list: importedData.budgets || []
                    });

                    await batch.commit(); // Commit all batch operations

                    showNotification('Data berhasil diimpor dan dipulihkan!', 'success');
                    // UI will update automatically via Firestore listeners
                } catch (error) {
                    console.error("Error parsing or importing JSON:", error);
                    showNotification('Gagal membaca atau mengurai file JSON. Pastikan formatnya benar dan tidak rusak.', 'error');
                }
            };
            reader.onerror = function() {
                showNotification('Gagal membaca file.', 'error');
            };
            reader.readAsText(file);
            event.target.value = ''; // Clear the file input value to allow selecting the same file again if needed
        }

        // --- Send All Data to WhatsApp (Click-to-Chat) ---
        function sendTransactionsToWhatsApp() {
            const targetPhoneNumber = '6282124064576'; // Nomor WhatsApp tujuan
            const transactions = getUserTransactions();
            let totalIncome = 0;
            let totalExpense = 0;

            transactions.forEach(t => {
                if (t.type === 'income') {
                    totalIncome += t.amount;
                } else {
                    totalExpense += t.amount;
                }
            });

            const currentBalance = totalIncome - totalExpense;

            // Prepare summary message
            let message = `Ringkasan Keuangan Anda:\n`;
            message += `Saldo Saat Ini: ${formatRupiah(currentBalance)}\n`;
            message += `Total Pemasukan: ${formatRupiah(totalIncome)}\n`;
            message += `Total Pengeluaran: ${formatRupiah(totalExpense)}\n\n`;

            // Add all transactions
            if (transactions.length > 0) {
                message += `Detail Semua Transaksi:\n`;
                // Sort transactions by date (newest first) for better readability
                transactions.sort((a, b) => new Date(b.date) - new Date(a.date));
                transactions.forEach(t => {
                    const typeLabel = t.type === 'income' ? 'Pemasukan' : 'Pengeluaran';
                    message += `- ${t.date} | ${typeLabel} | ${t.category} | ${formatRupiah(t.amount)} | ${t.description}\n`;
                });
            } else {
                message += `Belum ada transaksi tercatat.\n`;
            }

            // Encode the message for URL
            const encodedMessage = encodeURIComponent(message);
            const whatsappUrl = `https://wa.me/${targetPhoneNumber}?text=${encodedMessage}`;

            // Open WhatsApp in a new tab
            window.open(whatsappUrl, '_blank');

            showNotification('WhatsApp akan terbuka. Mohon kirim pesan secara manual.', 'info', 5000);
        }

        // --- Data Export (CSV) ---
        function exportTransactionsToCSV() {
            const transactions = getUserTransactions();
            if (transactions.length === 0) {
                showNotification('Tidak ada transaksi untuk diekspor.', 'error');
                return;
            }

            const headers = ["ID", "Tanggal", "Deskripsi", "Jumlah", "Tipe", "Kategori"];
            const csvRows = [];
            csvRows.push(headers.join(','));

            transactions.forEach(t => {
                const row = [
                    t.id,
                    t.date,
                    `"${t.description.replace(/"/g, '""')}"`, // Handle commas and quotes in description
                    t.amount,
                    t.type,
                    `"${t.category.replace(/"/g, '""')}"`
                ];
                csvRows.push(row.join(','));
            });

            const csvString = csvRows.join('\n');
            const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `transaksi_keuanganku_${currentFirebaseUser ? currentFirebaseUser.email : 'guest'}_${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            showNotification('Data berhasil diekspor!', 'success');
        }

        // --- Render Functions ---

        function renderDashboard() {
            // Display current username/email
            if (currentFirebaseUser) {
                dashboardUsernameEl.textContent = currentFirebaseUser.email;
                sidebarUsername.textContent = currentFirebaseUser.email;
            } else {
                dashboardUsernameEl.textContent = 'Tamu';
                sidebarUsername.textContent = 'Tamu';
            }

            const transactions = getUserTransactions();

            let totalIncome = 0;
            let totalExpense = 0;
            const expenseCategories = {};
            const incomeCategories = {};

            transactions.forEach(t => {
                if (t.type === 'income') {
                    totalIncome += t.amount;
                    incomeCategories[t.category] = (incomeCategories[t.category] || 0) + t.amount;
                } else {
                    totalExpense += t.amount;
                    expenseCategories[t.category] = (expenseCategories[t.category] || 0) + t.amount;
                }
            });

            const currentBalance = totalIncome - totalExpense;

            currentBalanceEl.textContent = formatRupiah(currentBalance);
            totalIncomeEl.textContent = formatRupiah(totalIncome);
            totalExpenseEl.textContent = formatRupiah(totalExpense);

            // Render Income/Expense Chart
            renderIncomeExpenseChart(totalIncome, totalExpense);

            // Render Expense by Category Summary
            renderCategorySummary(expenseByCategorySummary, expenseCategories, 'expense');

            // Display latest 5 transactions
            // Sort transactions by date (newest first). If dates are identical, their relative order is maintained.
            const latest = transactions.slice().sort((a, b) => {
                const dateA = new Date(a.date);
                const dateB = new Date(b.date);
                return dateB - dateA; // Sort by date descending (newest first)
            }).slice(0, 5); // Take only the top 5

            latestTransactionsEl.innerHTML = '';
            if (latest.length === 0) {
                latestTransactionsEl.innerHTML = '<p class="text-gray-500 text-center">Belum ada transaksi.</p>';
            } else {
                latest.forEach(t => {
                    const transactionDiv = document.createElement('div');
                    transactionDiv.className = `flex items-center justify-between p-3 rounded-lg border ${t.type === 'income' ? 'bg-green-50 border-green-200' : 'bg-red-50 border-red-200'}`;
                    transactionDiv.innerHTML = `
                        <div>
                            <p class="font-medium text-gray-800">${t.description}</p>
                            <p class="text-xs text-gray-500">${t.date} - ${t.category}</p>
                        </div>
                        <p class="font-semibold ${t.type === 'income' ? 'text-income' : 'text-expense'}">${formatRupiah(t.amount)}</p>
                    `;
                    latestTransactionsEl.appendChild(transactionDiv);
                });
            }
        }

        function renderIncomeExpenseChart(income, expense) {
            incomeExpenseChart.innerHTML = ''; // Clear previous chart
            const total = income + expense;
            let incomeHeight = 0;
            let expenseHeight = 0;

            if (total > 0) {
                incomeHeight = (income / total) * 100;
                expenseHeight = (expense / total) * 100;
            }

            const incomeBar = document.createElement('div');
            incomeBar.className = 'chart-bar chart-bar-income';
            incomeBar.style.height = `${incomeHeight}%`;
            incomeBar.innerHTML = `<span>${formatRupiah(income)}</span>`; /* Tampilkan jumlah di bar */

            const expenseBar = document.createElement('div');
            expenseBar.className = 'chart-bar chart-bar-expense';
            expenseBar.style.height = `${expenseHeight}%`;
            expenseBar.innerHTML = `<span>${formatRupiah(expense)}</span>`; /* Tampilkan jumlah di bar */

            incomeExpenseChart.appendChild(incomeBar);
            incomeExpenseChart.appendChild(expenseBar);
        }

        function renderCategorySummary(element, categoryData, type) {
            element.innerHTML = '';
            const sortedCategories = Object.entries(categoryData).sort(([, a], [, b]) => b - a);

            if (sortedCategories.length === 0) {
                element.innerHTML = `<p class="text-gray-500 text-center">Belum ada ${type === 'expense' ? 'pengeluaran' : 'pemasukan'} berdasarkan kategori.</p>`;
                return;
            }

            sortedCategories.forEach(([category, amount]) => {
                const div = document.createElement('div');
                div.className = 'flex justify-between items-center text-sm py-2 border-b border-gray-100 last:border-b-0';
                div.innerHTML = `
                    <span class="text-gray-700">${category}</span>
                    <span class="font-semibold ${type === 'income' ? 'text-income' : 'text-expense'}">${formatRupiah(amount)}</span>
                `;
                element.appendChild(div);
            });
        }

        function renderTransactions() {
            let transactions = getUserTransactions();

            // Apply search filter
            const searchTerm = transactionSearchInput.value.toLowerCase();
            if (searchTerm) {
                transactions = transactions.filter(t => t.description.toLowerCase().includes(searchTerm));
            }

            // Apply type filter
            const filterType = filterTypeSelect.value;
            if (filterType !== 'all') {
                transactions = transactions.filter(t => t.type === filterType);
            }

            // Apply date range filter
            const start = filterStartDate.value;
            const end = filterEndDate.value;
            if (start && end) {
                transactions = transactions.filter(t => t.date >= start && t.date <= end);
            } else if (start) {
                transactions = transactions.filter(t => t.date >= start);
            } else if (end) {
                transactions = transactions.filter(t => t.date <= end);
            }

            // Apply sort
            const sortBy = sortBySelect.value;
            transactions.sort((a, b) => {
                if (sortBy === 'dateDesc') return new Date(b.date) - new Date(a.date);
                if (sortBy === 'dateAsc') return new Date(a.date) - new Date(b.date);
                if (sortBy === 'amountDesc') return b.amount - a.amount;
                if (sortBy === 'amountAsc') return a.amount - b.amount;
                return 0;
            });

            filteredTransactions = transactions; // Store filtered transactions for pagination
            updatePaginationControls();
            const startIndex = (currentPage - 1) * transactionsPerPage;
            const endIndex = startIndex + transactionsPerPage;
            const transactionsToDisplay = filteredTransactions.slice(startIndex, endIndex);

            allTransactionsListEl.innerHTML = '';

            if (transactionsToDisplay.length === 0) {
                allTransactionsListEl.innerHTML = '<p class="text-gray-500 text-center">Belum ada transaksi.</p>';
            } else {
                transactionsToDisplay.forEach(t => {
                    const transactionDiv = document.createElement('div');
                    transactionDiv.className = `flex flex-col sm:flex-row items-start sm:items-center justify-between p-4 rounded-lg border border-gray-200 bg-white shadow-sm`;
                    transactionDiv.innerHTML = `
                        <div class="flex-grow mb-2 sm:mb-0">
                            <p class="font-medium text-gray-800 text-base">${t.description}</p>
                            <p class="text-sm text-gray-500">${t.date} - ${t.category}</p>
                        </div>
                        <div class="flex items-center gap-3 mt-2 sm:mt-0">
                            <p class="font-semibold text-base ${t.type === 'income' ? 'text-income' : 'text-expense'} mr-2">${formatRupiah(t.amount)}</p>
                            <button class="btn-secondary text-sm px-3 py-1.5" onclick="editTransaction('${t.id}')">Edit</button>
                            <button class="btn-danger text-sm px-3 py-1.5" onclick="deleteTransaction('${t.id}')">Hapus</button>
                        </div>
                    `;
                    allTransactionsListEl.appendChild(transactionDiv);
                });
            }
        }

        function updatePaginationControls() {
            const totalPages = Math.ceil(filteredTransactions.length / transactionsPerPage);
            pageInfo.textContent = `Halaman ${currentPage} dari ${totalPages || 1}`;
            prevPageBtn.disabled = currentPage === 1;
            nextPageBtn.disabled = currentPage === totalPages || totalPages === 0;
        }

        function goToPage(page) {
            currentPage = page;
            renderTransactions();
        }

        function nextPage() {
            if (currentPage * transactionsPerPage < filteredTransactions.length) {
                currentPage++;
                renderTransactions();
            }
        }

        function prevPage() {
            if (currentPage > 1) {
                currentPage--;
                renderTransactions();
            }
        }

        function populateReportYears() {
            const transactions = getUserTransactions();
            const years = new Set();
            transactions.forEach(t => years.add(new Date(t.date).getFullYear()));
            const sortedYears = Array.from(years).sort((a, b) => b - a);

            reportYearSelect.innerHTML = '<option value="all">Semua Tahun</option>';
            sortedYears.forEach(year => {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                reportYearSelect.appendChild(option);
            });
        }

        function renderReports() {
            let transactions = getUserTransactions();

            const selectedMonth = reportMonthSelect.value;
            const selectedYear = reportYearSelect.value;

            // Filter by month and year
            transactions = transactions.filter(t => {
                const date = new Date(t.date);
                const transactionMonth = (date.getMonth() + 1).toString().padStart(2, '0');
                const transactionYear = date.getFullYear().toString();

                const matchMonth = selectedMonth === 'all' || transactionMonth === selectedMonth;
                const matchYear = selectedYear === 'all' || transactionYear === selectedYear;

                return matchMonth && matchYear;
            });

            let totalIncome = 0;
            let totalExpense = 0;
            const expenseCategories = {};
            const incomeCategories = {};
            const monthlyData = {}; // For monthly summary chart

            transactions.forEach(t => {
                const date = new Date(t.date);
                const monthYear = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}`;

                if (!monthlyData[monthYear]) {
                    monthlyData[monthYear] = { income: 0, expense: 0 };
                }

                if (t.type === 'income') {
                    totalIncome += t.amount;
                    incomeCategories[t.category] = (incomeCategories[t.category] || 0) + t.amount;
                    monthlyData[monthYear].income += t.amount;
                } else {
                    totalExpense += t.amount;
                    expenseCategories[t.category] = (expenseCategories[t.category] || 0) + t.amount;
                    monthlyData[monthYear].expense += t.amount;
                }
            });

            const netBalance = totalIncome - totalExpense;

            reportTotalIncomeEl.textContent = formatRupiah(totalIncome);
            reportTotalExpenseEl.textContent = formatRupiah(totalExpense);
            reportNetBalanceEl.textContent = formatRupiah(netBalance);

            // Store report data globally for PDF generation
            window._currentReportData = {
                transactions: transactions,
                totalIncome: totalIncome,
                totalExpense: totalExpense,
                netBalance: netBalance,
                expenseCategories: expenseCategories,
                incomeCategories: incomeCategories,
                selectedMonth: selectedMonth,
                selectedYear: selectedYear
            };

            // Render category breakdown for reports
            renderCategorySummary(reportExpenseByCategory, expenseCategories, 'expense');
            renderCategorySummary(reportIncomeByCategory, incomeCategories, 'income');

            // Render Chart.js graphs
            renderMonthlySummaryChart(monthlyData);
            renderPieChart(expenseByCategoryChartCanvas, expenseCategories, 'Pengeluaran per Kategori', 'rgba(239, 68, 68, 0.8)'); // red-500
            renderPieChart(incomeByCategoryChartCanvas, incomeCategories, 'Pemasukan per Kategori', 'rgba(34, 197, 94, 0.8)'); // green-500

            reportTransactionsListEl.innerHTML = '';
            if (transactions.length === 0) {
                reportTransactionsListEl.innerHTML = '<p class="text-gray-500 text-center">Belum ada transaksi untuk laporan.</p>';
            } else {
                const table = document.createElement('table');
                table.className = 'responsive-table w-full text-sm';
                table.innerHTML = `
                    <thead>
                        <tr>
                            <th>Deskripsi</th>
                            <th>Tanggal</th>
                            <th>Jumlah</th>
                            <th>Tipe</th>
                            <th>Kategori</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                `;
                const tbody = table.querySelector('tbody');

                transactions.forEach(t => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${t.description}</td>
                        <td>${t.date}</td>
                        <td class="${t.type === 'income' ? 'text-income' : 'text-expense'}">${formatRupiah(t.amount)}</td>
                        <td>${t.type === 'income' ? 'Pemasukan' : 'Pengeluaran'}</td>
                        <td>${t.category}</td>
                    `;
                    tbody.appendChild(row);
                });
                reportTransactionsListEl.appendChild(table);
            }
        }

        function renderMonthlySummaryChart(monthlyData) {
            // Destroy existing chart instance if it exists
            if (monthlySummaryChartInstance) {
                monthlySummaryChartInstance.destroy();
            }

            const labels = Object.keys(monthlyData).sort();
            const incomeData = labels.map(month => monthlyData[month].income);
            const expenseData = labels.map(month => monthlyData[month].expense);

            monthlySummaryChartInstance = new Chart(monthlySummaryChartCanvas, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Pemasukan Bulanan',
                            data: incomeData,
                            backgroundColor: 'rgba(56, 161, 105, 0.8)', /* green-600 with opacity */
                            borderColor: 'rgba(56, 161, 105, 1)',
                            borderWidth: 1,
                            borderRadius: 6 /* Rounded bars */
                        },
                        {
                            label: 'Pengeluaran Bulanan',
                            data: expenseData,
                            backgroundColor: 'rgba(229, 62, 62, 0.8)', /* red-600 with opacity */
                            borderColor: 'rgba(229, 62, 62, 1)',
                            borderWidth: 1,
                            borderRadius: 6 /* Rounded bars */
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            stacked: false,
                            title: {
                                display: true,
                                text: 'Bulan',
                                color: document.body.classList.contains('dark-mode') ? '#e2e8f0' : '#333'
                            },
                            ticks: {
                                color: document.body.classList.contains('dark-mode') ? '#a0aec0' : '#333'
                            },
                            grid: {
                                display: false /* Hide grid lines */
                            }
                        },
                        y: {
                            stacked: false,
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Jumlah (Rp)',
                                color: document.body.classList.contains('dark-mode') ? '#e2e8f0' : '#333'
                            },
                            ticks: {
                                callback: function(value, index, values) {
                                    return formatRupiah(value);
                                },
                                color: document.body.classList.contains('dark-mode') ? '#a0aec0' : '#333'
                            },
                            grid: {
                                color: document.body.classList.contains('dark-mode') ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.1)'
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed.y !== null) {
                                        label += formatRupiah(context.parsed.y);
                                    }
                                    return label;
                                }
                            }
                        },
                        legend: {
                            labels: {
                                color: document.body.classList.contains('dark-mode') ? '#e2e8f0' : '#333',
                                font: {
                                    size: 14
                                }
                            }
                        }
                    }
                }
            });
        }

        function renderPieChart(canvasElement, categoryData, title, colorBase) {
            // Destroy existing chart instance if it exists
            let chartInstance;
            if (canvasElement === expenseByCategoryChartCanvas) {
                if (expenseByCategoryChartInstance) expenseByCategoryChartInstance.destroy();
                chartInstance = expenseByCategoryChartInstance;
            } else if (canvasElement === incomeByCategoryChartCanvas) {
                if (incomeByCategoryChartInstance) incomeByCategoryChartInstance.destroy();
                chartInstance = incomeByCategoryChartInstance;
            }

            const labels = Object.keys(categoryData);
            const data = Object.values(categoryData);

            // Generate dynamic colors
            const backgroundColors = labels.map((_, i) => {
                const hue = (i * 137.508) % 360;
                return `hsla(${hue}, 70%, 60%, 0.8)`;
            });
            const borderColors = labels.map((_, i) => {
                const hue = (i * 137.508) % 360;
                return `hsla(${hue}, 70%, 50%, 1)`;
            });

            const chartConfig = {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        label: title,
                        data: data,
                        backgroundColor: backgroundColors,
                        borderColor: borderColors,
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: false, // Title is handled in HTML
                            text: title
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed !== null) {
                                        label += formatRupiah(context.parsed);
                                    }
                                    return label;
                                }
                            }
                        },
                        legend: {
                            labels: {
                                color: document.body.classList.contains('dark-mode') ? '#e2e8f0' : '#333',
                                font: {
                                    size: 14
                                }
                            }
                        }
                    }
                }
            };

            if (canvasElement === expenseByCategoryChartCanvas) {
                expenseByCategoryChartInstance = new Chart(canvasElement, chartConfig);
            } else if (canvasElement === incomeByCategoryChartCanvas) {
                incomeByCategoryChartInstance = new Chart(canvasElement, chartConfig);
            }
        }

        // --- Analysis Functions ---

        function renderAnalysis() {
            const transactions = getUserTransactions();

            if (transactions.length === 0) {
                // Clear any existing charts and display a message
                if (financialTrendsChartInstance) financialTrendsChartInstance.destroy();
                if (topExpenseCategoriesChartInstance) topExpenseCategoriesChartInstance.destroy();
                if (topIncomeCategoriesChartInstance) topIncomeCategoriesChartInstance.destroy();

                // Clear canvas content (ensure it's actually cleared)
                const financialCtx = financialTrendsChartCanvas.getContext('2d');
                financialCtx.clearRect(0, 0, financialTrendsChartCanvas.width, financialTrendsChartCanvas.height);
                const expenseCtx = topExpenseCategoriesChartCanvas.getContext('2d');
                expenseCtx.clearRect(0, 0, topExpenseCategoriesChartCanvas.width, topExpenseCategoriesChartCanvas.height);
                const incomeCtx = topIncomeCategoriesChartCanvas.getContext('2d');
                incomeCtx.clearRect(0, 0, topIncomeCategoriesChartCanvas.width, topIncomeCategoriesChartCanvas.height);


                topExpenseCategoriesSummary.innerHTML = '<p class="text-gray-500 text-center">Belum ada data pengeluaran untuk analisis.</p>';
                topIncomeCategoriesSummary.innerHTML = '<p class="text-gray-500 text-center">Belum ada data pemasukan untuk analisis.</p>';
                return;
            }

            // 1. Calculate Monthly Financial Trends
            const monthlyData = calculateMonthlyFinancialData(transactions);
            renderFinancialTrendsChart(monthlyData);

            // 2. Calculate Top Categories
            const expenseCategories = calculateCategoryTotals(transactions, 'expense');
            const incomeCategories = calculateCategoryTotals(transactions, 'income');

            renderTopCategoriesChart(topExpenseCategoriesChartCanvas, expenseCategories, 'Pengeluaran', 'expense');
            renderTopCategoriesChart(topIncomeCategoriesChartCanvas, incomeCategories, 'Pemasukan', 'income');

            renderTopCategoriesSummary(topExpenseCategoriesSummary, expenseCategories, 'expense');
            renderTopCategoriesSummary(topIncomeCategoriesSummary, incomeCategories, 'income');
        }

        function calculateMonthlyFinancialData(transactions) {
            const monthlySummary = {};

            transactions.forEach(t => {
                const date = new Date(t.date);
                const monthYear = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}`;

                if (!monthlySummary[monthYear]) {
                    monthlySummary[monthYear] = { income: 0, expense: 0, balance: 0 };
                }

                if (t.type === 'income') {
                    monthlySummary[monthYear].income += t.amount;
                } else {
                    monthlySummary[monthYear].expense += t.amount;
                }
            });

            // Calculate cumulative balance
            const sortedMonths = Object.keys(monthlySummary).sort();
            let cumulativeBalance = 0;
            sortedMonths.forEach(month => {
                const data = monthlySummary[month];
                data.balance = data.income - data.expense;
                cumulativeBalance += data.balance;
                data.cumulativeBalance = cumulativeBalance; // Store cumulative balance
            });

            return monthlySummary;
        }

        function renderFinancialTrendsChart(monthlyData) {
            if (financialTrendsChartInstance) {
                financialTrendsChartInstance.destroy();
            }

            const labels = Object.keys(monthlyData).sort();
            const incomeData = labels.map(month => monthlyData[month].income);
            const expenseData = labels.map(month => monthlyData[month].expense);
            const balanceData = labels.map(month => monthlyData[month].cumulativeBalance); // Use cumulative balance

            financialTrendsChartInstance = new Chart(financialTrendsChartCanvas, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Pemasukan Bulanan',
                            data: incomeData,
                            borderColor: 'rgba(56, 161, 105, 1)', /* green-600 */
                            backgroundColor: 'rgba(56, 161, 105, 0.2)',
                            fill: true,
                            tension: 0.4 /* Lebih smooth */
                        },
                        {
                            label: 'Pengeluaran Bulanan',
                            data: expenseData,
                            borderColor: 'rgba(229, 62, 62, 1)', /* red-600 */
                            backgroundColor: 'rgba(229, 62, 62, 0.2)',
                            fill: true,
                            tension: 0.4
                        },
                        {
                            label: 'Saldo Kumulatif',
                            data: balanceData,
                            borderColor: 'rgba(49, 130, 206, 1)', /* blue-600 */
                            backgroundColor: 'rgba(49, 130, 206, 0.2)',
                            fill: true,
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Bulan',
                                color: document.body.classList.contains('dark-mode') ? '#e2e8f0' : '#333'
                            },
                            ticks: {
                                color: document.body.classList.contains('dark-mode') ? '#a0aec0' : '#333'
                            },
                             grid: {
                                display: false /* Hide grid lines */
                            }
                        },
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Jumlah (Rp)',
                                color: document.body.classList.contains('dark-mode') ? '#e2e8f0' : '#333'
                            },
                            ticks: {
                                callback: function(value, index, values) {
                                    return formatRupiah(value);
                                },
                                color: document.body.classList.contains('dark-mode') ? '#a0aec0' : '#333'
                            },
                            grid: {
                                color: document.body.classList.contains('dark-mode') ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.1)'
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed.y !== null) {
                                        label += formatRupiah(context.parsed.y);
                                    }
                                    return label;
                                }
                            }
                        },
                        legend: {
                            labels: {
                                color: document.body.classList.contains('dark-mode') ? '#e2e8f0' : '#333',
                                font: {
                                    size: 14
                                }
                            }
                        }
                    }
                }
            });
        }

        function calculateCategoryTotals(transactions, type) {
            const categoryTotals = {};
            transactions.forEach(t => {
                if (t.type === type) {
                    categoryTotals[t.category] = (categoryTotals[t.category] || 0) + t.amount;
                }
            });
            return categoryTotals;
        }

        function renderTopCategoriesChart(canvasElement, categoryData, titlePrefix, type) {
            let chartInstance;
            if (canvasElement === topExpenseCategoriesChartCanvas) {
                if (topExpenseCategoriesChartInstance) topExpenseCategoriesChartInstance.destroy();
                chartInstance = topExpenseCategoriesChartInstance;
            } else if (canvasElement === topIncomeCategoriesChartCanvas) {
                if (topIncomeCategoriesChartInstance) topIncomeCategoriesChartInstance.destroy();
                chartInstance = incomeByCategoryChartInstance;
            }

            const sortedCategories = Object.entries(categoryData)
                .sort(([, a], [, b]) => b - a)
                .slice(0, 5); // Get top 5

            const labels = sortedCategories.map(item => item[0]);
            const data = sortedCategories.map(item => item[1]);

            // Generate dynamic colors
            const backgroundColors = labels.map((_, i) => {
                const hue = (i * 137.508) % 360;
                return `hsla(${hue}, 70%, 60%, 0.8)`;
            });
            const borderColors = labels.map((_, i) => {
                const hue = (i * 137.508) % 360;
                return `hsla(${hue}, 70%, 50%, 1)`;
            });

            const chartConfig = {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: `${titlePrefix} (Rp)`,
                        data: data,
                        backgroundColor: backgroundColors,
                        borderColor: borderColors,
                        borderWidth: 1,
                        borderRadius: 6 /* Rounded bars */
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y', // Make it a horizontal bar chart
                    scales: {
                        x: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Jumlah (Rp)',
                                color: document.body.classList.contains('dark-mode') ? '#e2e8f0' : '#333'
                            },
                            ticks: {
                                callback: function(value, index, values) {
                                    return formatRupiah(value);
                                },
                                color: document.body.classList.contains('dark-mode') ? '#a0aec0' : '#333'
                            },
                            grid: {
                                display: false /* Hide grid lines */
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Kategori',
                                color: document.body.classList.contains('dark-mode') ? '#e2e8f0' : '#333'
                            },
                            ticks: {
                                color: document.body.classList.contains('dark-mode') ? '#a0aec0' : '#333'
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed.x !== null) {
                                        label += formatRupiah(context.parsed.x);
                                    }
                                    return label;
                                }
                            }
                        },
                        legend: {
                            labels: {
                                color: document.body.classList.contains('dark-mode') ? '#e2e8f0' : '#333',
                                font: {
                                    size: 14
                                }
                            }
                        }
                    }
                }
            };

            if (canvasElement === topExpenseCategoriesChartCanvas) {
                topExpenseCategoriesChartInstance = new Chart(canvasElement, chartConfig);
            } else if (canvasElement === topIncomeCategoriesChartCanvas) {
                topIncomeCategoriesChartInstance = new Chart(canvasElement, chartConfig);
            }
        }

        function renderTopCategoriesSummary(element, categoryData, type) {
            element.innerHTML = '';
            const sortedCategories = Object.entries(categoryData)
                .sort(([, a], [, b]) => b - a)
                .slice(0, 5); // Get top 5

            if (sortedCategories.length === 0) {
                element.innerHTML = `<p class="text-gray-500 text-center">Belum ada ${type === 'expense' ? 'pengeluaran' : 'pemasukan'} berdasarkan kategori.</p>`;
                return;
            }

            sortedCategories.forEach(([category, amount]) => {
                const div = document.createElement('div');
                div.className = 'flex justify-between items-center text-base py-2 border-b border-gray-100 last:border-b-0';
                div.innerHTML = `
                    <span class="text-gray-700">${category}</span>
                    <span class="font-semibold ${type === 'income' ? 'text-income' : 'text-expense'}">${formatRupiah(amount)}</span>
                `;
                element.appendChild(div);
            });
        }

        // --- Delete Own Account Function ---
        async function deleteOwnAccount() {
            if (!currentFirebaseUser) {
                showNotification('Fitur ini hanya untuk pengguna yang login.', 'error');
                return;
            }

            const confirmDelete = await new Promise(resolve => {
                showConfirmationModal('Ini akan menghapus akun Anda dan SEMUA data Anda secara permanen. Tindakan ini tidak dapat dibatalkan. Apakah Anda yakin?', () => resolve(true), () => resolve(false));
            });

            if (!confirmDelete) {
                showNotification('Penghapusan akun dibatalkan.', 'info');
                return;
            }

            const userId = currentFirebaseUser.uid;
            const userEmail = currentFirebaseUser.email;

            // Prompt for re-authentication
            const passwordPrompt = prompt("Untuk keamanan, masukkan kata sandi Anda untuk mengkonfirmasi penghapusan akun:");
            if (!passwordPrompt) {
                showNotification('Penghapusan akun dibatalkan (kata sandi tidak dimasukkan).', 'info');
                return;
            }

            try {
                const credential = EmailAuthProvider.credential(userEmail, passwordPrompt);
                await reauthenticateWithCredential(currentFirebaseUser, credential);

                // 1. Delete all transactions
                const transactionsRef = collection(db, `artifacts/${appId}/users/${userId}/transactions`);
                const transactionsSnapshot = await getDocs(transactionsRef);
                const deleteTransactionsBatch = writeBatch(db);
                transactionsSnapshot.docs.forEach(doc => {
                    deleteTransactionsBatch.delete(doc.ref);
                });
                await deleteTransactionsBatch.commit();
                console.log("All transactions deleted.");

                // 2. Delete metadata (categories, budgets)
                await deleteDoc(doc(db, `artifacts/${appId}/users/${userId}/metadata`, 'categories'));
                await deleteDoc(doc(db, `artifacts/${appId}/users/${userId}/metadata`, 'budgets'));
                console.log("Metadata deleted.");

                // 3. Delete the Firebase Authentication user
                await deleteFirebaseAuthUser(currentFirebaseUser);

                showNotification('Akun Anda dan semua data berhasil dihapus.', 'success');
                // onAuthStateChanged will handle redirecting to auth section
            } catch (error) {
                console.error("Error deleting account:", error);
                let errorMessage = 'Gagal menghapus akun. Silakan coba lagi.';
                if (error.code === 'auth/requires-recent-login') {
                    errorMessage = 'Untuk keamanan, Anda harus login ulang dan coba lagi.';
                } else if (error.code === 'auth/invalid-credential') {
                    errorMessage = 'Kata sandi yang dimasukkan salah. Penghapusan akun dibatalkan.';
                } else if (error.code === 'auth/network-request-failed') {
                    errorMessage = 'Kesalahan jaringan. Periksa koneksi internet Anda.';
                }
                showNotification(errorMessage, 'error');
            }
        }


        // --- Modal Functions ---
        function showConfirmationModal(message, onConfirm, onCancel) {
            confirmationModalMessage.textContent = message;
            confirmYesBtn.onclick = () => {
                hideConfirmationModal();
                if (onConfirm) onConfirm();
            };
            confirmNoBtn.onclick = () => {
                hideConfirmationModal();
                if (onCancel) onCancel();
            };
            confirmationModal.classList.remove('hidden');
        }

        function hideConfirmationModal() {
            confirmationModal.classList.add('hidden');
            confirmYesBtn.onclick = null;
            confirmNoBtn.onclick = null;
        }

        function showEditTransactionModal() {
            editTransactionModal.classList.remove('hidden');
        }

        function hideEditTransactionModal() {
            editTransactionModal.classList.add('hidden');
        }

        function showJsonDisplayModal() {
            jsonDisplayModal.classList.remove('hidden');
            // Select the text in the textarea to make it easy to copy
            jsonOutput.select();
            jsonOutput.setSelectionRange(0, 99999); // For mobile devices
        }

        function hideJsonDisplayModal() {
            jsonDisplayModal.classList.add('hidden');
        }

        // New: Forgot Password Modal functions
        function showForgotPasswordModal() {
            forgotPasswordModal.classList.remove('hidden');
            forgotPasswordMessageEl.classList.add('hidden'); // Clear previous messages
            forgotPasswordEmailInput.value = ''; // Clear input
        }

        function hideForgotPasswordModal() {
            forgotPasswordModal.classList.add('hidden');
        }

        // --- Chatbot Functions ---
        const chatbotQA = {
            "start": {
                question: "Halo! Saya asisten bantuan Anda. Silakan pilih topik yang ingin Anda ketahui lebih lanjut:",
                options: [
                    "Informasi Dashboard",
                    "Manajemen Transaksi",
                    "Rencana Anggaran",
                    "Laporan Keuangan",
                    "Analisis Keuangan",
                    "Pengaturan Akun",
                    "Verifikasi Email", // New option
                    "Kembali ke awal"
                ]
            },
            "Informasi Dashboard": {
                answer: "Dashboard adalah halaman utama yang menampilkan ringkasan keuangan Anda. Di sini Anda bisa melihat Saldo Saat Ini, Total Pemasukan, Total Pengeluaran, Ringkasan Pemasukan & Pengeluaran dalam bentuk grafik batang, serta Transaksi Terbaru Anda.",
                options: [
                    "Apa itu Saldo Saat Ini?",
                    "Apa itu Total Pemasukan/Pengeluaran?",
                    "Bagaimana grafik di Dashboard bekerja?",
                    "Transaksi Terbaru di Dashboard",
                    "Kembali ke awal"
                ]
            },
            "Apa itu Saldo Saat Ini?": {
                answer: "Saldo Saat Ini adalah jumlah uang yang Anda miliki, dihitung dari Total Pemasukan dikurangi Total Pengeluaran Anda."
            },
            "Apa itu Total Pemasukan/Pengeluaran?": {
                answer: "Total Pemasukan adalah jumlah semua transaksi dengan tipe 'Pemasukan'. Total Pengeluaran adalah jumlah semua transaksi dengan tipe 'Pengeluaran'."
            },
            "Bagaimana grafik di Dashboard bekerja?": {
                answer: "Grafik di Dashboard menampilkan perbandingan visual antara total pemasukan dan total pengeluaran Anda. Tinggi batang menunjukkan proporsi masing-masing terhadap total transaksi."
            },
            "Transaksi Terbaru di Dashboard": {
                answer: "Bagian 'Transaksi Terbaru' di Dashboard menampilkan hingga 5 transaksi terakhir yang Anda masukkan, memudahkan Anda untuk melacak aktivitas keuangan terkini."
            },
            "Manajemen Transaksi": {
                answer: "Di menu 'Transaksi', Anda bisa menambah, melihat, mengedit, dan menghapus semua transaksi keuangan Anda.",
                options: [
                    "Bagaimana cara menambahkan transaksi baru?",
                    "Bagaimana cara melihat daftar semua transaksi?",
                    "Bagaimana cara mencari, memfilter, dan mengurutkan transaksi?",
                    "Bagaimana cara mengedit transaksi yang sudah ada?",
                    "Bagaimana cara menghapus transaksi?",
                    "Apa fungsi paginasi di daftar transaksi?",
                    "Kembali ke awal"
                ]
            },
            "Bagaimana cara menambahkan transaksi baru?": {
                answer: "Untuk menambahkan transaksi baru, pergi ke menu 'Transaksi', lalu pada formulir 'Tambah Transaksi Baru', isi Tanggal, Deskripsi, Jumlah, pilih Tipe (Pemasukan/Pengeluaran), dan pilih Kategori. Setelah lengkap, klik tombol 'Tambah Transaksi'."
            },
            "Bagaimana cara melihat daftar semua transaksi?": {
                answer: "Daftar semua transaksi Anda dapat dilihat di bagian 'Daftar Semua Transaksi' pada menu 'Transaksi'. Transaksi akan ditampilkan dalam format daftar yang bisa Anda kelola."
            },
            "Bagaimana cara mencari, memfilter, dan mengurutkan transaksi?": {
                answer: "Di 'Daftar Semua Transaksi', Anda dapat menggunakan kolom 'Cari Deskripsi' untuk mencari berdasarkan teks, 'Filter Tipe' untuk memilih Pemasukan/Pengeluaran/Semua, 'Tanggal Mulai' dan 'Tanggal Akhir' untuk memfilter rentang waktu, serta 'Urutkan Berdasarkan' untuk mengurutkan data (Tanggal Terbaru/Terlama, Jumlah Terbesar/Terkecil)."
            },
            "Bagaimana cara mengedit transaksi yang sudah ada?": {
                answer: "Untuk mengedit transaksi, temukan transaksi di 'Daftar Semua Transaksi', lalu klik tombol 'Edit' di samping transaksi tersebut. Sebuah modal akan muncul, Anda bisa mengubah detail transaksi dan klik 'Simpan Perubahan'."
            },
            "Bagaimana cara menghapus transaksi?": {
                answer: "Untuk menghapus transaksi, temukan transaksi di 'Daftar Semua Transaksi', lalu klik tombol 'Hapus' di samping transaksi tersebut. Anda akan diminta konfirmasi sebelum transaksi dihapus secara permanen."
            },
            "Apa fungsi paginasi di daftar transaksi?": {
                answer: "Paginasi digunakan untuk membagi daftar transaksi menjadi beberapa halaman, biasanya 10 transaksi per halaman. Ini membantu dalam mengelola dan melihat data transaksi yang banyak secara lebih efisien. Anda bisa menggunakan tombol 'Sebelumnya' dan 'Berikutnya' untuk navigasi."
            },
            "Rencana Anggaran": {
                answer: "Menu 'Rencana Anggaran' memungkinkan Anda menetapkan batas pengeluaran untuk kategori tertentu dalam periode waktu tertentu. Anda akan diberi peringatan jika pengeluaran Anda melebihi anggaran yang ditetapkan.",
                options: [
                    "Bagaimana cara menetapkan anggaran baru?",
                    "Bagaimana cara melihat anggaran yang sudah ada?",
                    "Bagaimana cara menghapus anggaran?",
                    "Bagaimana peringatan anggaran bekerja?",
                    "Kembali ke awal"
                ]
            },
            "Bagaimana cara menetapkan anggaran baru?": {
                answer: "Di menu 'Rencana Anggaran', pada formulir 'Tetapkan Anggaran Baru', pilih Kategori, masukkan Jumlah Anggaran, dan tentukan Tanggal Mulai serta Tanggal Akhir periode anggaran. Klik 'Simpan Anggaran' untuk menyimpannya."
            },
            "Bagaimana cara melihat anggaran yang sudah ada?": {
                answer: "Daftar semua anggaran yang Anda tetapkan akan ditampilkan di bagian 'Daftar Anggaran Anda' pada menu 'Rencana Anggaran'. Anda bisa melihat detail setiap anggaran di sana."
            },
            "Bagaimana cara menghapus anggaran?": {
                answer: "Untuk menghapus anggaran, temukan anggaran di 'Daftar Anggaran Anda', lalu klik tombol 'Hapus' di samping anggaran tersebut. Anda akan diminta konfirmasi sebelum anggaran dihapus."
            },
            "Bagaimana peringatan anggaran bekerja?": {
                answer: "Ketika Anda menambahkan transaksi pengeluaran, sistem akan memeriksa apakah transaksi tersebut termasuk dalam kategori yang memiliki anggaran aktif. Jika jumlah transaksi baru akan menyebabkan total pengeluaran untuk kategori tersebut melebihi anggaran yang tersisa, sebuah peringatan akan muncul. Anda tetap bisa melanjutkan transaksi jika mau."
            },
            "Laporan Keuangan": {
                answer: "Menu 'Laporan' menyediakan ringkasan keuangan yang lebih mendalam, termasuk total pemasukan/pengeluaran, saldo bersih, serta grafik bulanan dan per kategori.",
                options: [
                    "Bagaimana cara memfilter laporan?",
                    "Jenis grafik apa saja yang ada di laporan keuangan?",
                    "Bagaimana cara melihat detail transaksi di laporan?",
                    "Kembali ke awal"
                ]
            },
            "Bagaimana cara memfilter laporan?": {
                answer: "Di menu 'Laporan', Anda bisa memfilter ringkasan laporan dan grafik berdasarkan 'Bulan' dan 'Tahun' tertentu, atau memilih 'Semua Bulan'/'Semua Tahun' untuk melihat data keseluruhan."
            },
            "Jenis grafik apa saja yang ada di laporan keuangan?": {
                answer: "Laporan keuangan menampilkan 'Grafik Pemasukan dan Pengeluaran Bulanan' (grafik batang) serta 'Pengeluaran per Kategori' dan 'Pemasukan per Kategori' (grafik lingkaran) untuk visualisasi data Anda."
            },
            "Bagaimana cara melihat detail transaksi di laporan?": {
                answer: "Di bagian bawah menu 'Laporan', terdapat 'Detail Transaksi' yang menampilkan daftar lengkap transaksi yang sesuai dengan filter bulan dan tahun yang Anda pilih di atas."
            },
            "Analisis Keuangan": {
                answer: "Bagian 'Analisis Keuangan' membantu Anda memahami tren dan pola pengeluaran/pemasukan Anda melalui grafik yang lebih mendalam.",
                options: [
                    "Apa itu Tren Keuangan Bulanan?",
                    "Apa itu 5 Kategori Pengeluaran/Pemasukan Teratas?",
                    "Kembali ke awal"
                ]
            },
            "Apa itu Tren Keuangan Bulanan?": {
                answer: "Grafik 'Tren Keuangan Bulanan' menunjukkan bagaimana pemasukan, pengeluaran, dan saldo kumulatif Anda berubah dari waktu ke waktu, memberikan gambaran tentang kesehatan finansial Anda."
            },
            "Apa itu 5 Kategori Pengeluaran/Pemasukan Teratas?": {
                answer: "Grafik ini menampilkan 5 kategori pengeluaran atau pemasukan terbesar Anda berdasarkan jumlah uang, membantu Anda mengidentifikasi area di mana Anda paling banyak menghabiskan atau menerima uang."
            },
            "Pengaturan Akun": {
                answer: "Menu 'Pengaturan' memungkinkan Anda untuk mengelola profil, kata sandi, kategori, serta melakukan backup dan ekspor data.",
                options: [
                    "Bagaimana cara mengubah kata sandi?",
                    "Bagaimana cara mengelola kategori?",
                    "Bagaimana cara backup/pulihkan data?",
                    "Bagaimana cara mengirim ringkasan transaksi ke WhatsApp?",
                    "Bagaimana cara mengekspor transaksi ke CSV?",
                    "Bagaimana cara menghapus akun saya?",
                    "Mode Gelap" // New option for dark mode
                ]
            },
            "Bagaimana cara mengubah kata sandi?": {
                answer: "Anda bisa mengubah kata sandi di menu 'Pengaturan', pada bagian 'Ubah Kata Sandi'. Masukkan kata sandi Anda saat ini, lalu masukkan kata sandi baru dan konfirmasinya. Pastikan kata sandi baru minimal 6 karakter."
            },
            "Bagaimana cara backup/pulihkan data?": {
                answer: "Anda dapat membackup data Anda ke file JSON lokal melalui menu 'Pengaturan', pada bagian 'Backup & Pulihkan Data (Lokal)'. Klik 'Ekspor Semua Data' untuk mengunduh file JSON, atau 'Impor Semua Data' untuk mengunggah file JSON dan memulihkan data Anda."
            },
            "Bagaimana cara mengirim ringkasan transaksi ke WhatsApp?": {
                answer: "Di menu 'Pengaturan', pada bagian 'Kirim Semua Transaksi ke WhatsApp', klik tombol 'Kirim Semua Transaksi ke WhatsApp'. Ini akan membuka aplikasi WhatsApp Anda dengan ringkasan keuangan dan detail transaksi yang sudah terisi, siap untuk Anda kirim."
            },
            "Bagaimana cara mengekspor transaksi ke CSV?": {
                answer: "Di menu 'Pengaturan', pada bagian 'Ekspor Data Transaksi (CSV)', klik tombol 'Ekspor Transaksi ke CSV'. Semua transaksi Anda akan diunduh sebagai file CSV yang dapat dibuka di program spreadsheet seperti Excel."
            },
            "Bagaimana cara menghapus akun saya?": {
                answer: "Di menu 'Pengaturan', pada bagian 'Hapus Akun', Anda dapat menghapus akun Anda secara permanen. Tindakan ini tidak dapat dibatalkan dan akan menghapus semua data Anda."
            },
            "Mode Gelap": { // New chatbot response for dark mode
                answer: "Mode gelap memungkinkan Anda mengubah tampilan aplikasi menjadi skema warna yang lebih gelap, yang dapat mengurangi ketegangan mata, terutama di lingkungan dengan cahaya rendah. Anda bisa mengaktifkan atau menonaktifkannya dari menu 'Pengaturan' di bagian 'Mode Tampilan'."
            },
            "Verifikasi Email": { // New section for chatbot
                answer: "Untuk memastikan keamanan akun Anda, kami memerlukan verifikasi email. Setelah mendaftar, tautan verifikasi akan dikirim ke email Anda. Anda harus mengklik tautan tersebut sebelum dapat masuk. Jika Anda tidak menerima email, silakan cek folder spam atau coba masuk lagi untuk memicu pengiriman ulang.",
                options: [
                    "Mengapa verifikasi email diperlukan?",
                    "Apa yang harus dilakukan jika tidak menerima email verifikasi?",
                    "Kembali ke awal"
                ]
            },
            "Mengapa verifikasi email diperlukan?": {
                answer: "Verifikasi email diperlukan untuk keamanan akun Anda. Ini membantu memastikan bahwa alamat email yang digunakan adalah milik Anda dan mencegah akses tidak sah."
            },
            "Apa yang harus dilakukan jika tidak menerima email verifikasi?": {
                answer: "Jika Anda tidak menerima email verifikasi, silakan periksa folder spam atau junk Anda. Terkadang, email bisa masuk ke sana. Anda juga bisa mencoba masuk kembali ke aplikasi; ini sering kali akan memicu pengiriman ulang email verifikasi."
            },
            "Bantuan Admin": {
                answer: "Fitur ini hanya tersedia untuk pengguna dengan peran 'Admin'. Admin dapat mengelola pengguna lain yang terdaftar di aplikasi. Namun, fungsi manajemen pengguna lain dari sisi klien tidak didukung secara langsung oleh Firebase SDK karena alasan keamanan. Ini memerlukan fungsi backend (misalnya, Firebase Cloud Functions)."
            },
            "Kembali ke awal": {
                answer: "Baik, apa lagi yang bisa saya bantu? Silakan pilih topik dari daftar di bawah:",
                options: [
                    "Informasi Dashboard",
                    "Manajemen Transaksi",
                    "Rencana Anggaran",
                    "Laporan Keuangan",
                    "Analisis Keuangan",
                    "Pengaturan Akun",
                    "Verifikasi Email", // New option
                    "Kembali ke awal"
                ]
            }
        };

        function startChatbot() {
            displayBotMessage(chatbotQA.start.question);
            displayChatOptions(chatbotQA.start.options);
        }

        function displayBotMessage(message) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'chat-message bot';
            messageDiv.textContent = message;
            chatDisplay.appendChild(messageDiv);
            chatDisplay.scrollTop = chatDisplay.scrollHeight; // Scroll to bottom
        }

        function displayUserMessage(message) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'chat-message user';
            messageDiv.textContent = message;
            chatDisplay.appendChild(messageDiv);
            chatDisplay.scrollTop = chatDisplay.scrollHeight; // Scroll to bottom
        }

        function displayChatOptions(options) {
            chatOptions.innerHTML = ''; // Clear previous options
            options.forEach(optionText => {
                const button = document.createElement('button');
                button.textContent = optionText;
                button.addEventListener('click', () => handleChatOptionClick(optionText));
                chatOptions.appendChild(button);
            });
        }

        function handleChatOptionClick(optionText) {
            displayUserMessage(optionText); // Show user's choice
            const response = chatbotQA[optionText];
            if (response) {
                displayBotMessage(response.answer);
                if (response.options) {
                    displayChatOptions(response.options);
                } else {
                    // If no further options, offer to go back to start
                    displayChatOptions(["Kembali ke awal"]);
                }
            } else {
                displayBotMessage("Maaf, saya tidak mengerti pertanyaan itu. Silakan pilih dari opsi yang tersedia atau ketik 'Kembali ke awal'.");
                displayChatOptions(["Kembali ke awal"]);
            }
            chatDisplay.scrollTop = chatDisplay.scrollHeight; // Scroll to bottom after new messages
        }

        // --- PDF Generation Function ---
        async function generatePdfReport() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            const reportData = window._currentReportData;

            if (!reportData || !reportData.transactions) {
                showNotification('Tidak ada data laporan untuk dibuat PDF.', 'error');
                return;
            }

            const monthNames = ["Januari", "Februari", "Maret", "April", "Mei", "Juni",
                "Juli", "Agustus", "September", "Oktober", "November", "Desember"
            ];

            let titleMonth = reportData.selectedMonth === 'all' ? 'Semua Bulan' : monthNames[parseInt(reportData.selectedMonth) - 1];
            let titleYear = reportData.selectedYear === 'all' ? 'Semua Tahun' : reportData.selectedYear;
            let reportTitle = `Laporan Keuangan: ${titleMonth} ${titleYear}`;

            let yOffset = 20;

            doc.setFontSize(18);
            doc.text(reportTitle, 14, yOffset);
            yOffset += 10;

            doc.setFontSize(12);
            doc.text(`Total Pemasukan: ${formatRupiah(reportData.totalIncome)}`, 14, yOffset);
            yOffset += 7;
            doc.text(`Total Pengeluaran: ${formatRupiah(reportData.totalExpense)}`, 14, yOffset);
            yOffset += 7;
            doc.text(`Saldo Bersih: ${formatRupiah(reportData.netBalance)}`, 14, yOffset);
            yOffset += 10;

            // Expense by Category
            doc.setFontSize(14);
            doc.text("Pengeluaran per Kategori:", 14, yOffset);
            yOffset += 7;
            if (Object.keys(reportData.expenseCategories).length > 0) {
                for (const category in reportData.expenseCategories) {
                    doc.setFontSize(12);
                    doc.text(`  ${category}: ${formatRupiah(reportData.expenseCategories[category])}`, 14, yOffset);
                    yOffset += 7;
                }
            } else {
                doc.setFontSize(12);
                doc.text("  Belum ada pengeluaran berdasarkan kategori.", 14, yOffset);
                yOffset += 7;
            }
            yOffset += 5;

            // Income by Category
            doc.setFontSize(14);
            doc.text("Pemasukan per Kategori:", 14, yOffset);
            yOffset += 7;
            if (Object.keys(reportData.incomeCategories).length > 0) {
                for (const category in reportData.incomeCategories) {
                    doc.setFontSize(12);
                    doc.text(`  ${category}: ${formatRupiah(reportData.incomeCategories[category])}`, 14, yOffset);
                    yOffset += 7;
                }
            } else {
                doc.setFontSize(12);
                doc.text("  Belum ada pemasukan berdasarkan kategori.", 14, yOffset);
                yOffset += 7;
            }
            yOffset += 5;

            // Transaction Details
            doc.setFontSize(14);
            doc.text("Detail Transaksi:", 14, yOffset);
            yOffset += 7;

            if (reportData.transactions.length > 0) {
                const tableColumn = ["Tanggal", "Deskripsi", "Jumlah", "Tipe", "Kategori"];
                const tableRows = [];

                reportData.transactions.forEach(t => {
                    const transactionData = [
                        t.date,
                        t.description,
                        formatRupiah(t.amount),
                        t.type === 'income' ? 'Pemasukan' : 'Pengeluaran',
                        t.category
                    ];
                    tableRows.push(transactionData);
                });

                doc.autoTable({
                    head: [tableColumn],
                    body: tableRows,
                    startY: yOffset,
                    theme: 'striped',
                    headStyles: { fillColor: [44, 62, 80] }, // Dark sidebar color for header
                    styles: { fontSize: 10, cellPadding: 2, overflow: 'linebreak' },
                    columnStyles: {
                        0: { cellWidth: 20 }, // Date
                        1: { cellWidth: 50 }, // Description
                        2: { cellWidth: 30 }, // Amount
                        3: { cellWidth: 20 }, // Type
                        4: { cellWidth: 30 }  // Category
                    }
                });
            } else {
                doc.setFontSize(12);
                doc.text("  Belum ada transaksi untuk laporan.", 14, yOffset);
            }

            doc.save(`Laporan_Keuangan_${titleMonth}_${titleYear}.pdf`);
            showNotification('Laporan PDF berhasil dibuat!', 'success');
        }


        // --- Event Listeners ---

        // Toggle sidebar on mobile
        menuBtn.addEventListener('click', () => {
            sidebar.classList.toggle('open');
        });

        // Close sidebar when clicking outside on mobile (optional, but good UX)
        document.addEventListener('click', (event) => {
            if (window.innerWidth < 768 && sidebar.classList.contains('open') && !sidebar.contains(event.target) && !menuBtn.contains(event.target)) {
                sidebar.classList.remove('open');
            }
        });

        // Authentication form submission
        authForm.addEventListener('submit', handleAuth);

        // Toggle between login and register modes
        toggleAuthModeBtn.addEventListener('click', (event) => {
            event.preventDefault();
            if (authMode === 'login') {
                authMode = 'register';
                authTitle.textContent = 'Daftar';
                authSubmitBtn.textContent = 'Daftar';
                toggleAuthModeBtn.textContent = 'Login di sini'; // Changed text
            } else {
                authMode = 'login';
                authTitle.textContent = 'Login';
                authSubmitBtn.textContent = 'Login';
                toggleAuthModeBtn.textContent = 'Daftar di sini';
            }
            authMessage.classList.add('hidden'); // Clear message on mode switch
            usernameInput.value = ''; // Clear fields
            passwordInput.value = ''; // Clear fields
        });

        // New: Forgot Password Link click
        forgotPasswordLink.addEventListener('click', (event) => {
            event.preventDefault();
            showForgotPasswordModal();
        });

        // New: Forgot Password Form submission
        forgotPasswordForm.addEventListener('submit', async (event) => {
            event.preventDefault();
            const email = forgotPasswordEmailInput.value.trim();
            forgotPasswordMessageEl.classList.add('hidden'); // Hide previous message

            if (!email) {
                showMessage(forgotPasswordMessageEl, 'Email tidak boleh kosong.', true);
                showNotification('Email tidak boleh kosong.', 'error');
                return;
            }

            try {
                await sendPasswordResetEmail(auth, email);
                showMessage(forgotPasswordMessageEl, 'Link reset kata sandi telah dikirim ke email Anda. Silakan cek kotak masuk Anda.', false);
                showNotification('Link reset kata sandi telah dikirim!', 'success');
                forgotPasswordEmailInput.value = ''; // Clear email input
            } catch (error) {
                console.error("Error sending password reset email:", error);
                let errorMessage = 'Gagal mengirim link reset kata sandi. Silakan coba lagi.';
                if (error.code === 'auth/invalid-email') {
                    errorMessage = 'Format email tidak valid.';
                } else if (error.code === 'auth/user-not-found') {
                    errorMessage = 'Tidak ada pengguna dengan email tersebut.';
                }
                showMessage(forgotPasswordMessageEl, errorMessage, true);
                showNotification(errorMessage, 'error');
            }
        });

        // Logout button
        logoutBtn.addEventListener('click', handleLogout);

        // Sidebar navigation
        sidebarItems.forEach(item => {
            item.addEventListener('click', (event) => {
                event.preventDefault();
                const sectionId = event.currentTarget.dataset.section + 'Section'; // Use currentTarget
                if (isLoggedIn) {
                    showSection(sectionId);
                } else {
                    showMessage(authMessage, 'Anda harus login terlebih dahulu.', true);
                    showNotification('Anda harus login terlebih dahulu.', 'error');
                }
            });
        });

        // Transaction form submission
        transactionForm.addEventListener('submit', addTransaction);

        // Filter, Sort, Search, and Pagination listeners
        transactionSearchInput.addEventListener('input', () => { currentPage = 1; renderTransactions(); });
        filterTypeSelect.addEventListener('change', () => { currentPage = 1; renderTransactions(); });
        filterStartDate.addEventListener('change', () => { currentPage = 1; renderTransactions(); });
        filterEndDate.addEventListener('change', () => { currentPage = 1; renderTransactions(); });
        sortBySelect.addEventListener('change', () => { currentPage = 1; renderTransactions(); });
        prevPageBtn.addEventListener('click', prevPage);
        nextPageBtn.addEventListener('click', nextPage);

        // Budget form submission
        budgetForm.addEventListener('submit', addBudget);

        // Edit Transaction Form Submission
        editTransactionForm.addEventListener('submit', updateTransaction);

        // Change Password Form Submission
        changePasswordForm.addEventListener('submit', handleChangePassword);

        // Add Category Form Submission
        addCategoryForm.addEventListener('submit', addCategory);

        // Local Data Import/Export
        exportAllDataBtn.addEventListener('click', exportAllData);
        importAllDataInput.addEventListener('change', importAllData);

        // Copy JSON to clipboard button
        copyJsonBtn.addEventListener('click', () => {
            jsonOutput.select();
            document.execCommand('copy');
            showNotification('Data JSON berhasil disalin ke clipboard!', 'success');
            hideJsonDisplayModal();
        });

        // Send WhatsApp All Transactions Button
        sendWhatsappSummaryBtn.addEventListener('click', sendTransactionsToWhatsApp);

        // Export Data Button (CSV)
        exportDataBtn.addEventListener('click', exportTransactionsToCSV);

        // Report Filters
        reportMonthSelect.addEventListener('change', renderReports);
        reportYearSelect.addEventListener('change', renderReports);

        // Generate PDF Report Button
        generatePdfReportBtn.addEventListener('click', generatePdfReport);

        // Delete Account Button
        deleteAccountBtn.addEventListener('click', deleteOwnAccount);

        // Dark Mode Toggle Listener
        darkModeToggle.addEventListener('change', toggleDarkMode);


        // --- Initial Load ---
        document.addEventListener('DOMContentLoaded', async () => {
            // Handle initial auth token from Canvas environment
            if (initialAuthToken) {
                try {
                    await auth.signInWithCustomToken(initialAuthToken);
                    showNotification('Login otomatis berhasil!', 'success');
                } catch (error) {
                    console.error("Custom token sign-in error:", error);
                    showNotification('Gagal login otomatis. Silakan login manual.', 'error');
                }
            } else {
                // If no custom token, no anonymous sign-in by default now, user must explicitly login/register
            }

            // Set default date for transaction form to today
            const today = new Date().toISOString().split('T')[0];
            transactionDateInput.value = today;
            editTransactionDateInput.value = today; // Also for edit form
            budgetStartDateInput.value = today; // Set default start date for budget
            budgetEndDateInput.value = today; // Set default end date for budget
        });

        // Make functions globally accessible for onclick in HTML
        window.deleteTransaction = deleteTransaction;
        window.editTransaction = editTransaction;
        window.deleteCategory = deleteCategory;
        window.hideConfirmationModal = hideConfirmationModal; // For modal close button
        window.hideEditTransactionModal = hideEditTransactionModal; // For modal close button
        window.confirmAction = showConfirmationModal; // Expose for internal use
        window.hideJsonDisplayModal = hideJsonDisplayModal; // Expose for modal close button
        window.deleteBudget = deleteBudget; // Expose for budget deletion
        window.hideForgotPasswordModal = hideForgotPasswordModal; // Expose for modal close button

        // Cegah pinch zoom (Prevent pinch zoom)
        document.addEventListener('gesturestart', function (e) {
            e.preventDefault();
        });

        document.addEventListener('gesturechange', function (e) {
            e.preventDefault();
        });

        document.addEventListener('gestureend', function (e) {
            e.preventDefault();
        });

        // Cegah double-tap zoom (Prevent double-tap zoom)
        let lastTouchEnd = 0;
        document.addEventListener('touchend', function (event) {
            const now = (new Date()).getTime();
            if (now - lastTouchEnd <= 300) {
                event.preventDefault();
            }
            lastTouchEnd = now;
        }, false);

        feather.replace();
    </script>
</body>
</html>
